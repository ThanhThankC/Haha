<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ThankVocab ‚Äî T·ª´ V·ª±ng</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%230080ff' viewBox='0 0 24 24'%3E%3Cpath d='M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 2c1.7 0 3.1 2.7 3.5 6H8.5C8.9 6.7 10.3 4 12 4zm-4.4 8H7c0 1.6.3 3 0.8 4.2-1.4-1.2-2.3-2.9-2.2-4.2zm1.9 0h6.9c-.4 3.3-2 6-3.4 6s-3-2.7-3.5-6zM17 12h-.6c.2-1.3-.3-3-.8-4.2 1.4 1.2 2.3 2.9 2.2 4.2z'/%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #0d0f14;
  --surface: #161921;
  --surface2: #1e2230;
  --border: #2a2f3f;
  --text: #e8eaf0;
  --text2: #8892a4;
  --accent: #5b8dee;
  --green: #3ecf8e;
  --amber: #f5a623;
  --red: #f06060;
  --pink: #e879a8;
  --level-color: #5b8dee;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* Layout */
.app{display:flex;height:100vh}

/* Sidebar */
.sidebar{width:256px;min-width:256px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.logo{padding:20px 20px 14px;font-family:'Playfair Display',serif;font-size:21px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--pink));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;border-bottom:1px solid var(--border)}
.logo span{display:block;font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);-webkit-text-fill-color:var(--text2);margin-top:2px}

/* Sidebar search */
.sb-search{padding:10px 12px 2px}
.sb-search-wrap{position:relative}
.sb-search-wrap svg.s-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text2);pointer-events:none}
#gSearch{width:100%;padding:8px 28px 8px 32px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
#gSearch:focus{border-color:var(--accent)}
#gSearch::placeholder{color:var(--text2)}
.s-clear{position:absolute;right:7px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;padding:2px;border-radius:4px;display:none;align-items:center;justify-content:center;transition:color .15s}
.s-clear:hover{color:var(--text)}
.s-clear.vis{display:flex}
.drawer-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);opacity:0;transition:opacity .25s;pointer-events:none}
.drawer-overlay.open{opacity:1;pointer-events:all}
.drawer{position:fixed;left:0;top:0;bottom:0;width:280px;z-index:201;background:var(--surface);border-right:1px solid var(--border);transform:translateX(-100%);transition:transform .28s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow-y:auto}
.drawer.open{transform:translateX(0)}
.drawer-close{position:absolute;top:12px;right:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;width:32px;height:32px;cursor:pointer;color:var(--text2);display:flex;align-items:center;justify-content:center;transition:background .15s}
.drawer-close:hover{background:var(--border);color:var(--text)}
.mob-menu-btn{display:none;background:var(--surface2);border:1px solid var(--border);border-radius:9px;width:36px;height:36px;cursor:pointer;color:var(--text2);align-items:center;justify-content:center;flex-shrink:0;transition:background .15s}
.mob-menu-btn:hover{background:var(--border);color:var(--text)}
.mob-search-wrap{display:none;position:relative;flex:1;min-width:0}
.mob-search-wrap svg.s-ico{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text2);pointer-events:none}
#gSearchMob{width:100%;padding:7px 28px 7px 30px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
#gSearchMob:focus{border-color:var(--accent)}
#gSearchMob::placeholder{color:var(--text2)}

/* Nav */
.nav-section{padding:10px 12px 4px}
.nav-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text2);padding:0 8px 8px}
.lvl-btn{display:flex;align-items:center;gap:10px;width:100%;padding:9px 12px;border-radius:10px;background:transparent;border:none;color:var(--text);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;transition:background .15s;text-align:left}
.lvl-btn:hover{background:var(--surface2)}
.lvl-btn.active{background:var(--surface2)}
.lvl-btn .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.lvl-btn .cnt{margin-left:auto;font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);background:var(--surface2);padding:2px 7px;border-radius:20px;min-width:28px;text-align:center;transition:background .15s}
.lvl-btn.active .cnt{background:var(--border)}
.sb-bottom{margin-top:auto;padding:12px;border-top:1px solid var(--border)}

/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* Header */
.header{display:flex;align-items:center;gap:12px;padding:13px 22px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;flex-wrap:wrap}
.h-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--level-color);transition:color .3s}
.h-actions{display:flex;gap:8px;margin-left:auto}

/* Toolbar */
.toolbar{display:flex;align-items:center;gap:10px;padding:8px 22px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;flex-wrap:wrap}
.sort-sel{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:8px;font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;outline:none}
.cb{margin-left:auto;font-family:'DM Mono',monospace;font-size:11px;color:var(--text2)}

/* Btns */
.btn{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:9px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;transition:opacity .15s,transform .1s}
.btn:hover{opacity:.85}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff}
.btn-ghost{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-danger{background:var(--red);color:#fff}
.btn-sm{padding:5px 11px;font-size:12px;border-radius:7px}

/* Vocab container */
.vc{flex:1;overflow-y:auto;padding:14px 22px;transition:background .4s}
.vg{display:flex;flex-direction:column;gap:8px}

/* Search banner */
.s-banner{background:color-mix(in srgb,var(--accent) 10%,var(--surface2));border:1px solid color-mix(in srgb,var(--accent) 30%,var(--border));border-radius:10px;padding:9px 14px;margin-bottom:10px;font-size:13px;display:flex;align-items:center;gap:10px}
.s-banner strong{color:var(--accent)}
.s-banner button{margin-left:auto;background:none;border:none;color:var(--text2);cursor:pointer;font-size:12px;padding:3px 8px;border-radius:6px;transition:background .15s}
.s-banner button:hover{background:var(--border)}

/* Card */
.vcard{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:flex-start;gap:12px;transition:border-color .15s,background .15s;position:relative;overflow:hidden}
.vcard:hover{background:var(--surface2);border-color:color-mix(in srgb,var(--level-color) 55%,var(--border))}
.vcard-bar{position:absolute;left:0;top:0;bottom:0;width:7px;border-radius:3px 0 0 3px}
.vcard-badge{width:27px;height:27px;border-radius:8px;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;letter-spacing:-.3px}
.vcard-body{flex:1;min-width:0}
.vcard-title{font-size:15px;font-weight:600;line-height:1.4}
.vcard-title .word{color:var(--text)}
.vcard-title .meaning{color:var(--text2);font-weight:400}
.vcard-meta{display:flex;align-items:center;gap:6px;margin-top:5px;flex-wrap:wrap}
.tag{font-size:11px;padding:2px 8px;border-radius:20px;font-weight:500}
.tag-type{background:rgba(91,141,238,.15);color:#7aaeff}
.tag-custom{background:rgba(126,83,191,.15);color:#b08aef}
.dtxt{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2)}

/* Freshness bar */
.fbar-wrap{margin-top:5px;display:flex;align-items:center;gap:7px}
.fbar{height:3px;border-radius:2px;transition:width .3s}
.flbl{font-size:10px;font-family:'DM Mono',monospace}

/* Card actions */
.cactions{display:flex;gap:5px;opacity:0;transition:opacity .15s;flex-shrink:0}
.vcard:hover .cactions{opacity:1}
.iBtn{width:28px;height:28px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s}
.iBtn:hover{background:var(--border);color:var(--text)}
.iBtn.del:hover{background:rgba(240,96,96,.15);color:var(--red);border-color:var(--red)}

/* Load more */
.lm-btn{width:100%;padding:11px;background:var(--surface2);border:1px dashed var(--border);border-radius:10px;color:var(--text2);font-size:13px;cursor:pointer;margin-top:8px;transition:border-color .15s,color .15s;font-family:'DM Sans',sans-serif}
.lm-btn:hover{border-color:var(--accent);color:var(--accent)}

/* Empty */
.empty{text-align:center;padding:60px 20px;color:var(--text2)}
.empty svg{margin-bottom:16px;opacity:.3}
.empty h3{font-size:16px;margin-bottom:6px;color:var(--text)}

/* Spinner */
.spin{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite;margin:40px auto}
@keyframes sp{to{transform:rotate(360deg)}}

/* Modal */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .2s}
.moverlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:540px;max-width:96vw;max-height:92vh;overflow-y:auto;transform:translateY(14px);transition:transform .2s}
.moverlay.open .modal{transform:translateY(0)}
.modal-title{font-family:'Playfair Display',serif;font-size:19px;margin-bottom:16px}
.fg{margin-bottom:14px}
.flabel{display:block;font-size:11px;font-weight:600;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:5px}
.finput,.fselect,.ftarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);padding:8px 11px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.finput:focus,.fselect:focus,.ftarea:focus{border-color:var(--accent)}
.ftarea{resize:vertical;min-height:72px}
.frow{display:flex;gap:12px}
.frow .fg{flex:1}
input[type=date]{color-scheme:dark}

/* Word type chips - each type gets a color */
.wt-grid{display:flex;flex-wrap:wrap;gap:6px}
.wt-chip{padding:5px 11px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:2px solid transparent;background:var(--surface2);color:var(--text2);transition:all .15s;user-select:none;display:flex;align-items:center;gap:5px}
.wt-chip:hover{opacity:.85;transform:scale(1.04)}
.wt-chip.sel{color:#fff}
.wt-chip .x-btn{background:rgba(255,255,255,.25);border:none;color:inherit;width:14px;height:14px;border-radius:50%;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;padding:0;line-height:1;flex-shrink:0;transition:background .12s}
.wt-chip .x-btn:hover{background:rgba(255,255,255,.45)}
.wt-add{padding:5px 12px;border-radius:20px;font-size:12px;background:none;border:2px dashed var(--border);color:var(--text2);cursor:pointer;transition:all .15s}
.wt-add:hover{border-color:var(--accent);color:var(--accent)}

/* Tags */
.tags-wrap{display:flex;gap:6px;flex-wrap:wrap;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:6px 10px;min-height:38px;cursor:text}
.tags-wrap:focus-within{border-color:var(--accent)}
.tag-chip{display:flex;align-items:center;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:2px 9px;font-size:12px}
.tag-chip button{background:none;border:none;color:var(--text2);cursor:pointer;padding:0;line-height:1;font-size:14px}
.tag-chip button:hover{color:var(--red)}
.tag-inp{background:transparent;border:none;outline:none;color:var(--text);font-size:13px;font-family:'DM Sans',sans-serif;min-width:80px}

/* Color */
.cprow{display:flex;gap:7px;flex-wrap:wrap;align-items:center}
.cswatch{width:24px;height:24px;border-radius:7px;cursor:pointer;border:2px solid transparent;transition:transform .1s,border-color .15s;flex-shrink:0}
.cswatch:hover,.cswatch.sel{transform:scale(1.18);border-color:white}

/* Color popup */
.cpop{position:fixed;z-index:500;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-wrap:wrap;gap:6px;width:220px;box-shadow:0 8px 32px rgba(0,0,0,.75)}

/* Modal footer */
.mfoot{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:14px;border-top:1px solid var(--border)}

/* Level editor */
.le-item{padding:10px 0;border-bottom:1px solid var(--border)}
.le-item .ni{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;width:100%}
.le-item .ni:focus{border-color:var(--accent)}
.lc-btn{width:28px;height:28px;border-radius:8px;border:2px solid transparent;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.lc-btn:hover{border-color:white}

/* Phonetic */
.phonetic{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);font-style:italic}

/* Speaker button */
.spk-btn{background:none;border:none;cursor:pointer;color:var(--text2);padding:0;display:flex;align-items:center;transition:color .15s;flex-shrink:0}
.spk-btn:hover{color:var(--accent)}
.spk-btn.playing{color:var(--green)}

/* Search highlight */
.hl{background:rgba(245,166,35,.28);color:var(--amber);border-radius:2px;padding:0 1px}

/* Total badge in sidebar */
.total-row{display:flex;align-items:center;justify-content:space-between;padding:6px 20px 8px;border-bottom:1px solid var(--border)}
.total-lbl{font-size:10px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:1px}
.total-val{font-family:'DM Mono',monospace;font-size:12px;color:var(--text);font-weight:600}

/* Toast */
.toast-c{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:400}
.toast{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 16px;font-size:13px;animation:tin .25s ease,tout .25s ease 2.5s forwards;max-width:300px}
.toast.ok{border-color:var(--green)}
.toast.err{border-color:var(--red)}
@keyframes tin{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes tout{from{opacity:1}to{opacity:0}}

/* ‚îÄ‚îÄ‚îÄ WORD FAMILY ‚îÄ‚îÄ‚îÄ */
.wf-group{display:flex;flex-direction:column;gap:0}
.wf-child{display:flex;align-items:flex-start;gap:0;position:relative}
.wf-indent-line{flex-shrink:0;display:flex;flex-direction:column;align-items:center}
.wf-vline{width:2px;background:var(--border);flex:1;margin-left:18px}
.wf-hline{width:14px;height:2px;background:var(--border);margin-top:16px;flex-shrink:0}
.wf-child-wrap{flex:1;min-width:0;padding-top:5px}
.vcard.depth-1{transform:scale(0.97);transform-origin:left center;opacity:0.82}
.vcard.depth-2{transform:scale(0.94);transform-origin:left center;opacity:0.68}
.vcard.depth-3{transform:scale(0.91);transform-origin:left center;opacity:0.55}
.depth-1 .vcard-title .word{font-size:14px}
.depth-2 .vcard-title .word{font-size:13px}
.depth-3 .vcard-title .word{font-size:12px}
.wf-connector{display:flex;padding-left:4px;margin-bottom:0}
.wf-connector-inner{display:flex;flex-direction:column;align-items:flex-start;margin-right:4px}

.iBtn.wf-has-parent{color:var(--accent);border-color:color-mix(in srgb,var(--accent) 40%,var(--border))}

/* Set Parent Modal */
.sp-modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;width:420px;max-width:96vw;max-height:80vh;display:flex;flex-direction:column;gap:10px}
.sp-search-wrap{position:relative}
.sp-search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text2);pointer-events:none}
.sp-inp{width:100%;padding:9px 12px 9px 34px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
.sp-inp:focus{border-color:var(--accent)}
.sp-results{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:4px;min-height:60px;max-height:320px}
.sp-item{padding:9px 12px;border-radius:9px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:border-color .15s,background .15s;display:flex;align-items:center;gap:10px}
.sp-item:hover{background:var(--border);border-color:var(--accent)}
.sp-item-word{font-size:13px;font-weight:600;color:var(--text)}
.sp-item-meta{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace}
.sp-none-btn{padding:9px 12px;border-radius:9px;background:none;border:2px dashed var(--border);color:var(--text2);font-size:12px;cursor:pointer;transition:border-color .15s,color .15s;font-family:'DM Sans',sans-serif;text-align:left;display:flex;align-items:center;gap:8px}
.sp-none-btn:hover{border-color:var(--red);color:var(--red)}
.sp-hint{font-size:11px;color:var(--text2);text-align:center;padding:12px 0;opacity:.6}

/* Scrollbar */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text2)}

/* Range */
input[type=range]{-webkit-appearance:none; appearance:none;width:100%;height:4px;background:var(--border);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}


/* ‚îÄ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ‚îÄ */
@media(max-width:640px){
  .sidebar{display:none}
  .app{height:100dvh}
  .main{flex:1;overflow:hidden;display:flex;flex-direction:column;min-width:0}
  .mob-menu-btn{display:flex}
  .mob-search-wrap{display:block}
  .drawer-overlay{display:block}
  .header{padding:8px 10px;gap:7px;flex-wrap:nowrap}
  .h-title{display:none}
  .h-actions .btn-primary{padding:6px 10px;font-size:12px;white-space:nowrap;flex-shrink:0}
  .toolbar{padding:5px 12px;gap:6px;flex-wrap:nowrap}
  .sort-sel{font-size:11px;padding:4px 7px}
  .cb{font-size:10px}
  .vc{padding:8px 10px;flex:1;overflow-y:auto}
  .vcard{padding:9px 10px;gap:9px}
  .vcard-badge{width:23px;height:23px;font-size:8px}
  .vcard-title{font-size:13px}
  .cactions{opacity:1}
  .iBtn{width:30px;height:30px}
  .moverlay{align-items:flex-end}
  .modal{border-radius:16px 16px 0 0;max-height:90dvh;width:100%;max-width:100%}
  .frow{flex-direction:column;gap:0}
  /* Mobile: c√¢y gia ƒë√¨nh g·ªçn h∆°n ‚Äî depth 2+ kh√¥ng indent s√¢u, thu nh·ªè card */
  .wf-mobile-child{margin-left:10px!important;padding-left:4px!important;border-left:2px solid var(--border)}
  .vcard.depth-2,.vcard.depth-3{transform:none;opacity:1}
  .vcard.depth-2 .vcard-title .word,.vcard.depth-3 .vcard-title .word{font-size:12px}
  .vcard.depth-2,.vcard.depth-3{padding:6px 8px;gap:7px}
  .vcard.depth-2 .vcard-badge,.vcard.depth-3 .vcard-badge{width:18px;height:18px;font-size:7px}
  .vcard.depth-2 .fbar-wrap,.vcard.depth-3 .fbar-wrap{display:none}
  .vcard.depth-2 .vcard-meta .dtxt,.vcard.depth-3 .vcard-meta .dtxt{display:none}
}
  /* ‚îÄ‚îÄ‚îÄ RAINBOW ANIMATION ‚îÄ‚îÄ‚îÄ */
.rb-bg {
  background: linear-gradient(90deg, #ff3b3b, #ff9d00, #eaff00, #00ff66, #00aeff, #b300ff, #ff3b3b);
  background-size: 200% auto;
  animation: rbMove 2.5s linear infinite;
}
.rb-txt {
  background: linear-gradient(90deg, #ff3b3b, #ff9d00, #eaff00, #00ff66, #00aeff, #b300ff, #ff3b3b);
  background-size: 200% auto;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: rbMove 2.5s linear infinite;
  font-weight: 700;
  text-transform: none;
}
@keyframes rbMove { to { background-position: 200% center; } }
</style>
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc,
  updateDoc, deleteDoc, query, getCountFromServer
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const fbApp = initializeApp({
  apiKey:"AIzaSyCnlgJEFCEOk0e6oeMS4wXOyQv1kCG5ikU",
  authDomain:"wordlist-b2f44.firebaseapp.com",
  projectId:"wordlist-b2f44",
  storageBucket:"wordlist-b2f44.firebasestorage.app",
  messagingSenderId:"76634142406",
  appId:"1:76634142406:web:041b9c4ec1a673414c49c7",
  measurementId:"G-L1BCD1XWJR"
});
const db = getFirestore(fbApp);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PAGE = 30;

const PAL = [
  '#4a9eff','#3ecf8e','#f5a623','#e879a8','#a78bfa','#ffd700',
  '#64d8cb','#f06060','#60d4f0','#b0e060','#ff7f50','#c792ea',
  '#82aaff','#ffcb6b','#f07178','#89ddff'
];

const WT_COLORS = {
  'n':      {bg:'#1e3a5f',border:'#4a9eff',text:'#7ec8ff'},
  'v':      {bg:'#1a3d2b',border:'#3ecf8e',text:'#6de8b0'},
  'adj':    {bg:'#3d2e14',border:'#f5a623',text:'#ffc96b'},
  'adv':    {bg:'#3d1a30',border:'#e879a8',text:'#f5a0ca'},
  'prep':   {bg:'#281e45',border:'#a78bfa',text:'#c4aff9'},
  'conj':   {bg:'#1e3535',border:'#64d8cb',text:'#96e8e0'},
  'phrase': {bg:'#2e1e3d',border:'#c792ea',text:'#dbb8f5'},
  'phr.v':  {bg:'#3a2010',border:'#ff7f50',text:'#ffaa88'},
};
const WT_PAL_CYCLE=[
  {bg:'#1a2e3d',border:'#60d4f0',text:'#90e4f8'},
  {bg:'#2e3a10',border:'#b0e060',text:'#d0f090'},
  {bg:'#3a1a1a',border:'#f07178',text:'#f8a0a6'},
  {bg:'#1a1a3a',border:'#89ddff',text:'#b8eeff'},
];
function wtColor(type){
  const lc=type.toLowerCase();
  if(WT_COLORS[lc]) return WT_COLORS[lc];
  let h=0; for(const c of lc) h=(h*31+c.charCodeAt(0))%WT_PAL_CYCLE.length;
  return WT_PAL_CYCLE[h];
}

function hlText(text, q){
  if(!q||!text) return esc(text);
  const safeQ=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const re=new RegExp(`(${safeQ})`,'gi');
  return esc(text).replace(re,'<mark class="hl">$1</mark>');
}

const DEF_LEVELS = [
  {id:'D', name:'C·∫•p D', color:'#4a9eff'},
  {id:'C', name:'C·∫•p C', color:'#3ecf8e'},
  {id:'B', name:'C·∫•p B', color:'#f5a623'},
  {id:'A', name:'C·∫•p A', color:'#e879a8'},
  {id:'S', name:'C·∫•p S', color:'#a78bfa'},
  {id:'SS',name:'C·∫•p SS',color:'#ffd700'},
  {id:'CT',name:'C·ª•m T·ª´',color:'#64d8cb'},
];

const DEF_WTYPES = ['n','v','adj','adv','prep','conj','phrase','phr.v'];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE (OFFLINE FIRST) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const S = {
  levels:    JSON.parse(localStorage.getItem('vv_levels')||'null') || DEF_LEVELS,
  wtypes:    JSON.parse(localStorage.getItem('vv_wtypes')||'null') || DEF_WTYPES,
  localDB:   JSON.parse(localStorage.getItem('vv_localDB')||'{}'), // RAM Cache to√†n b·ªô data
  counts:    JSON.parse(localStorage.getItem('vv_counts')||'{}'),
  activeLevel: null,
  shown: [],          
  shownLimit: PAGE,   // D√πng cho ph√¢n trang local
  searchMode: false,
  searchQ: '',
  sortBy: 'newest',
  editWord: null,
  editLevel: null
};

// H√†m l∆∞u LocalDB an to√†n
function saveLocalDB() {
  try {
    localStorage.setItem('vv_localDB', JSON.stringify(S.localDB));
  } catch (e) {
    console.error("Local Storage is full!", e);
    toast('C·∫£nh b√°o: B·ªô nh·ªõ cache tr√¨nh duy·ªát ƒë·∫ßy', 'err');
  }
}

// L·∫•y m·∫£ng data ƒë√£ ƒë∆∞·ª£c sort t·ª´ RAM
function getLevelData(lid) {
  let arr = [...(S.localDB[lid] || [])];
  if (S.sortBy === 'newest') arr.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
  if (S.sortBy === 'oldest') arr.sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
  if (S.sortBy === 'alpha')  arr.sort((a,b) => (a.content||'').localeCompare(b.content||''));
  return arr;
}

const col = id => 'vocab_' + id;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNC LOGIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// H√†m n√†y ch·∫°y ng·∫ßm ƒë·ªÉ check xem Firebase c√≥ thay ƒë·ªïi g√¨ so v·ªõi Local kh√¥ng
async function syncLevel(lid) {
  try {
    const fbCount = (await getCountFromServer(collection(db, col(lid)))).data().count;
    const localCount = S.localDB[lid] ? S.localDB[lid].length : 0;
    
    S.counts[lid] = fbCount;
    localStorage.setItem('vv_counts', JSON.stringify(S.counts));
    updateTotalUI();
    const el = document.getElementById('cnt_'+lid);
    if (el) el.textContent = fbCount;

    // K·ªãch b·∫£n: B·ªã l·ªách data (Ho·∫∑c l·∫ßn ƒë·∫ßu m·ªü web) => L·∫•y to√†n b·ªô t·ª´ Firebase v·ªÅ ƒë√® v√†o Local
    if (fbCount !== localCount) {
      if (!S.localDB[lid]) toast(`ƒêang ƒë·ªìng b·ªô ${ln(lid)} l·∫ßn ƒë·∫ßu...`, 'ok');
      
      const snap = await getDocs(query(collection(db, col(lid))));
      S.localDB[lid] = snap.docs.map(d => ({id: d.id, ...d.data(), _lid: lid}));
      saveLocalDB();

      // N·∫øu ng∆∞·ªùi d√πng ƒëang xem ƒë√∫ng c√°i List v·ª´a t·∫£i xong -> Render l·∫°i ngay l·∫≠p t·ª©c
      if (S.activeLevel === lid && !S.searchMode) {
        S.shown = getLevelData(lid).slice(0, S.shownLimit);
        rMain();
      }
    }
  } catch (e) { console.error("Sync fail", e); }
}

function updateTotalUI() {
  const total = Object.values(S.counts).reduce((a,b) => a+(typeof b==='number'?b:0), 0);
  const t0 = new Date(); t0.setHours(0,0,0,0);
  let nNew = 0;
  for (const l of S.levels)
    for (const w of (S.localDB[l.id]||[]))
      if (w.createdAt && w.createdAt >= t0.getTime()) nNew++;
  const txt = total.toLocaleString();
  ['totalVal','drawerTotalVal'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    // C·∫≠p nh·∫≠t text m√† kh√¥ng ƒë·ª•ng v√†o badge span (tr√°nh reset animation)
    let textNode = el.childNodes[0];
    if(!textNode || textNode.nodeType !== Node.TEXT_NODE){
      // Ch∆∞a c√≥ text node -> set l·∫°i to√†n b·ªô
      el.innerHTML = '';
      textNode = document.createTextNode(txt);
      el.appendChild(textNode);
    } else {
      textNode.textContent = txt;
    }
    // T√¨m ho·∫∑c t·∫°o badge span
    let badge = el.querySelector('.rb-badge');
    if(nNew >= 1){
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'rb-txt rb-badge';
        badge.style.cssText = 'font-size:11px;white-space:nowrap;margin-left:3px';
        el.appendChild(badge);
      }
      badge.textContent = '(+' + nNew + ')';
    } else {
      if(badge) badge.remove();
    }
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOCAL SEARCH (0 READS) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function doGlobalSearch(qStr) {
  const q = qStr.toLowerCase().trim();
  let res = [];
  
  // Qu√©t to√†n b·ªô RAM Cache
  for (const l of S.levels) {
    const wds = (S.localDB[l.id] || []).filter(w => (w.content||'').toLowerCase().includes(q));
    res.push(...wds);
  }

  // S·∫Øp x·∫øp: ∆Øu ti√™n t·ª´ kh·ªõp ngay ƒë·∫ßu c√¢u, sau ƒë√≥ ƒë·∫øn ng√†y t·∫°o
  res.sort((a,b)=>{
    const ai=(a.content||'').toLowerCase().indexOf(q);
    const bi=(b.content||'').toLowerCase().indexOf(q);
    if(ai!==bi) return ai-bi;
    return (b.createdAt||0)-(a.createdAt||0);
  });

  return res.slice(0, 100); // Tr·∫£ v·ªÅ t·ªëi ƒëa 100 k·∫øt qu·∫£ m∆∞·ª£t m√†
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRESHNESS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function lerpHex(a,b,t){
  const p=c=>[parseInt(c.slice(1,3),16),parseInt(c.slice(3,5),16),parseInt(c.slice(5,7),16)];
  const [ar,ag,ab]=p(a),[br,bg,bb]=p(b);
  return '#'+[ar+(br-ar)*t,ag+(bg-ag)*t,ab+(bb-ab)*t].map(v=>Math.round(v).toString(16).padStart(2,'0')).join('');
}
function freshInfo(ts){
  if(!ts) return {color:'#8892a4',label:'?',w:'4%'};
  // T√≠nh s·ªë ng√†y theo midnight Vi·ªát Nam (UTC+7)
  const VN_OFFSET = 7 * 60 * 60 * 1000;
  const nowVN = Date.now() + VN_OFFSET;
  const tsVN  = ts        + VN_OFFSET;
  const todayMidnightVN = Math.floor(nowVN / 86400000) * 86400000;
  const wordMidnightVN  = Math.floor(tsVN  / 86400000) * 86400000;
  const d = (todayMidnightVN - wordMidnightVN) / 86400000; // s·ªë ng√†y nguy√™n, t√≠nh t·ª´ 0
  let color,label,pct;
  if(d === 0){ color = 'rainbow';  label = 'New'; pct = 100; }
  else if(d<=10){color=lerpHex('#3ecf8e','#a8e63a',d/10);label=Math.round(d)+'d';pct=95-d*5}
  else if(d<=20){color=lerpHex('#a8e63a','#f5a623',(d-10)/10);label=Math.round(d)+'d';pct=80-(d-10)*2}
  else if(d<=40){color=lerpHex('#f5a623','#f07030',(d-20)/20);label=Math.round(d)+'d';pct=60-(d-20)*1}
  else if(d<=90){color=lerpHex('#f07030','#f06060',(d-40)/50);label=Math.round(d)+'d';pct=40-(d-40)*.4}
  else{color='#f06060';label=Math.floor(d/30)+'m';pct=8}
  return {color,label,w:Math.max(5,Math.round(pct))+'%'};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const esc = s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function getContrastColor(hex){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return (r*299+g*587+b*114)/1000 > 140 ? '#1a1a2e' : '#ffffff';
}
// L·∫•y m√†u badge/bar c·ªßa level (m√†u 1 ho·∫∑c gradient css string)
const lc  = id=>{ const l=S.levels.find(l=>l.id===id); return l?.color||'#5b8dee'; };
const lcGrad = id=>{ const l=S.levels.find(l=>l.id===id); return l?.color2 ? `linear-gradient(135deg,${l.color},${l.color2})` : (l?.color||'#5b8dee'); };
const lcText = id=>{ const l=S.levels.find(l=>l.id===id); return l?.textColor||(l?.color2?getContrastColor(l.color):'#ffffff'); };
const ln  = id=>S.levels.find(l=>l.id===id)?.name||id;

function setLevelColor(c, c2){
  document.documentElement.style.setProperty('--level-color',c);
  const vc=document.querySelector('.vc');
  const mixC=c2||c;
  if(vc) vc.style.background=`linear-gradient(160deg,color-mix(in srgb,${mixC} 17%,var(--bg)) 0%,var(--bg) 65%)`;
}

function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rSidebar(){
  document.getElementById('lvlNav').innerHTML=S.levels.map(l=>{
    const cnt=S.counts[l.id]!==undefined?S.counts[l.id]:'‚Ä¶';
    const active=S.activeLevel===l.id&&!S.searchMode;
    const dotStyle=l.color2?`background:linear-gradient(135deg,${l.color},${l.color2})`:`background:${l.color}`;
    return `<button class="lvl-btn ${active?'active':''}" onclick="selLevel('${l.id}')">
      <span class="dot" style="${dotStyle}"></span>
      <span>${esc(l.name)}</span>
      <span class="cnt" id="cnt_${l.id}">${cnt}</span>
    </button>`;
  }).join('');
  updateTotalUI();
  if(typeof rDrawer==='function') rDrawer();
}function rMain(){
  const main=document.getElementById('mainC');
  const al=S.levels.find(l=>l.id===S.activeLevel);
  const lcolor=al?.color||'#5b8dee';
  
  if(!S.activeLevel&&!S.searchMode){
      setLevelColor('#5b8dee');
      main.innerHTML=`<div class="empty" style="margin:auto;padding:80px 20px"><svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><h3>Ch·ªçn m·ªôt c·∫•p ƒë·ªô</h3></div>`;
      return;
  }
  
  setLevelColor(lcolor, al?.color2);
  const title = S.searchMode ? 'üîç K·∫øt qu·∫£ t√¨m ki·∫øm' : (al?.name||'');
  const cnt2 = S.searchMode ? `T√¨m th·∫•y: <strong>${S.shown.length}</strong>` : `T·ªïng: <strong>${S.counts[S.activeLevel]??'?'}</strong> ‚Ä¢ Hi·ªÉn th·ªã: <strong>${S.shown.length}</strong>`;
  
  const hasMoreLocal = !S.searchMode && S.localDB[S.activeLevel] && (S.shownLimit < S.localDB[S.activeLevel].length);
  const mixC=al?.color2||lcolor;

  // Ki·ªÉm tra xem header ƒë√£ t·ªìn t·∫°i ch∆∞a (ƒë·ªÉ kh√¥ng rebuild khi ƒëang focus search mobile)
  const existingHeader = document.getElementById('mainHeader');
  const headerHTML = `
  <div class="header" id="mainHeader">
    <button class="mob-menu-btn" onclick="openDrawer()" title="Menu">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="h-title">${title}</div>
    <div class="mob-search-wrap">
      <svg class="s-ico" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
<input id="gSearchMob" type="text" placeholder="T√¨m t·ª´ v·ª±ng‚Ä¶" oninput="syncMobSearch(this)" value="${S.searchQ}" autocomplete="off" list="searchHistoryList"/>
      <button class="s-clear ${S.searchQ?'vis':''}" id="gSearchMobClear" onclick="clearSearch(true,'gSearchMob')" title="X√≥a">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="h-actions">
      <button class="btn btn-primary btn-sm" onclick="openAdd()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Th√™m t·ª´
      </button>
    </div>
  </div>`;

  const bodyHTML = `
  <div class="toolbar" id="mainToolbar">
    <span style="font-size:11px;color:var(--text2);font-weight:600">S·∫ÆP X·∫æP:</span>
    <select class="sort-sel" onchange="handleSort(this.value)" ${S.searchMode?'disabled':''}>
      <option value="newest" ${S.sortBy==='newest'?'selected':''}>M·ªõi nh·∫•t</option>
      <option value="oldest" ${S.sortBy==='oldest'?'selected':''}>C≈© nh·∫•t</option>
      <option value="alpha"  ${S.sortBy==='alpha'?'selected':''}>A ‚Üí Z</option>
    </select>
    <span class="cb">${cnt2}</span>
  </div>
  <div class="vc" id="vcont" style="background:linear-gradient(160deg,color-mix(in srgb,${mixC} 17%,var(--bg)) 0%,var(--bg) 65%)">
    <div class="vg" id="vgrid">
      ${rWordList()}
    </div>
    ${hasMoreLocal ? `<button class="lm-btn" onclick="loadMore()">T·∫£i th√™m ${PAGE} t·ª´...</button>` : ''}
  </div>`;

  // N·∫øu search mobile ƒëang active (focus), ch·ªâ update body, gi·ªØ nguy√™n header
  const mobSearchFocused = document.activeElement && document.activeElement.id === 'gSearchMob';
  if (existingHeader && mobSearchFocused) {
    // Ch·ªâ update ph·∫ßn toolbar + content, kh√¥ng ƒë·ª•ng v√†o header ch·ª©a input ƒëang focus
    const existingToolbar = document.getElementById('mainToolbar');
    const existingVcont = document.getElementById('vcont');
    if (existingToolbar && existingVcont) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = bodyHTML;
      existingToolbar.replaceWith(tempDiv.querySelector('#mainToolbar'));
      document.getElementById('vcont').replaceWith(tempDiv.querySelector('#vcont'));
      // Update title n·∫øu c·∫ßn
      const htitle = existingHeader.querySelector('.h-title');
      if (htitle) htitle.textContent = title.replace(/üîç /, 'üîç ');
    } else {
      main.innerHTML = headerHTML + bodyHTML;
    }
  } else {
    main.innerHTML = headerHTML + bodyHTML;
  }
}

function rWordList(){
  if(!S.shown.length) return `<div class="empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><h3>Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o</h3><p>Nh·∫•n "Th√™m t·ª´" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p></div>`;
  let h='';
  if(S.searchMode){
    h+=`<div class="s-banner">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <span>K·∫øt qu·∫£ cho <strong>"${esc(S.searchQ)}"</strong> ‚Äî ${S.shown.length} t·ª´</span>
      <button onclick="clearSearch()">‚úï X√≥a</button>
    </div>`;
    h += rWordFamily(S.shown); // c√¢y b·∫≠c thang ch·ªâ khi search
  } else {
    h += S.shown.map(w=>rCard(w,0)).join(''); // flat list b√¨nh th∆∞·ªùng
  }
  return h;
}

// Build a flat list with family-tree structure (depth-aware, b·∫≠c thang)
function rWordFamily(words){
  // Build children map from ALL localDB first (needed for sort + render)
  const childrenMap = {};
  for(const l of S.levels){
    for(const w of (S.localDB[l.id]||[])){
      if(w.parentId){
        if(!childrenMap[w.parentId]) childrenMap[w.parentId]=[];
        childrenMap[w.parentId].push(w);
      }
    }
  }

  // Determine which words in our list are already children of other words in our list
  const shownIds = new Set(words.map(w=>w.id));
  // roots = words whose parent is NOT in our shown list (or has no parent)
  let roots = words.filter(w => !w.parentId || !shownIds.has(w.parentId));

  // Sort roots by the newest createdAt in their subtree (so newest family group floats up)
  function maxCreatedAt(w){
    let m = w.createdAt||0;
    for(const c of (childrenMap[w.id]||[])) m = Math.max(m, maxCreatedAt(c));
    return m;
  }
  roots = roots.slice().sort((a,b) => maxCreatedAt(b) - maxCreatedAt(a));

  function renderNode(w, depth){
    const card = rCard(w, depth);
    let children = (childrenMap[w.id]||[]);
    // Ch·ªâ hi·ªán children c√≥ trong shown list (ho·∫∑c children c·ªßa t·ª´ matched)
    children = children.filter(c => shownIds.has(c.id) || shownIds.has(w.id));

    if(!children.length){
      // Leaf node
      if(depth === 0) return `<div style="margin-bottom:0">${card}</div>`;
      return card;
    }

    // Node c√≥ children ‚Äî render ƒë·ªá quy
    const indent = 20 + depth * 4; // indent tƒÉng nh·∫π theo depth
    const childrenHTML = `<div class="${depth>=1?'wf-mobile-child':''}" style="margin-left:${indent}px;margin-top:5px;display:flex;flex-direction:column;gap:5px;padding-left:8px">`
      + children.map(c => renderNode(c, depth+1)).join('')
      + `</div>`;

    return `<div>${card}${childrenHTML}</div>`;
  }

  let out = '<div style="display:flex;flex-direction:column;gap:8px">';
  // Avoid duplicates (children already rendered under parents)
  const rendered = new Set();
  function collectIds(w){
    rendered.add(w.id);
    (childrenMap[w.id]||[]).forEach(c=>collectIds(c));
  }
  for(const r of roots){
    out += renderNode(r,0,false);
    collectIds(r);
  }
  // Any orphan words that weren't rendered (parent exists but not in list)
  for(const w of words){
    if(!rendered.has(w.id)) out += renderNode(w,0,false);
  }
  out += '</div>';
  return out;
}

function rCard(w, depth=0){
  const lid=w._lid||S.activeLevel;
  const lcolor=lc(lid);
  const lgrad=lcGrad(lid);
  const ltxt=lcText(lid);
  const lname=ln(lid).replace('C·∫•p ','').replace('C·ª•m T·ª´','CT');
  let wd=w.content||'',mng='';
  const ci=wd.indexOf(':');
  if(ci>-1){mng=wd.slice(ci+1).trim();wd=wd.slice(0,ci).trim();}
  const types=Array.isArray(w.wordTypes)?w.wordTypes:(w.wordType?[w.wordType]:[]);
  const q=S.searchMode?S.searchQ:'';
  const ttags=types.map(t=>{
    const c=wtColor(t);
    return `<span class="tag" style="background:${c.bg};border:1px solid ${c.border};color:${c.text}">${esc(t)}</span>`;
  }).join('');
  const ctags=(w.tags||[]).map(t=>`<span class="tag tag-custom">${esc(t)}</span>`).join('');
  const dt=w.createdAt?new Date(w.createdAt).toLocaleDateString('vi-VN'):'';
  const fr=freshInfo(w.createdAt);
  const wdHl=q?hlText(wd,q):esc(wd);
  const mngHl=q?hlText(mng,q):esc(mng);
  const phonetic=w.phonetic?`<span class="phonetic">${esc(w.phonetic)}</span>`:'';
  const spkBtn=w.audioUrl
    ?`<button class="spk-btn" title="Ph√°t √¢m" onclick="playAudio(event,'${esc(w.audioUrl)}')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
      </button>`
    :'';
  const depthClass = depth > 0 ? ` depth-${Math.min(depth,3)}` : '';
  // Check if this word has children (across all levels)
  let hasChildren = false;
  for(const l of S.levels){ if((S.localDB[l.id]||[]).some(x=>x.parentId===w.id)){hasChildren=true;break;} }
  const familyIcon = hasChildren
    ? `<span title="Word Family" style="font-size:10px;color:var(--accent);opacity:0.7;margin-left:4px">üåø</span>` : '';
  const parentInfo = w.parentId ? (() => {
    let par = null;
    for(const l of S.levels){ par=(S.localDB[l.id]||[]).find(x=>x.id===w.parentId); if(par)break; }
    if(!par) return '';
    const pw = par.content?.split(':')[0]?.trim()||'';
    return `<span style="font-size:10px;color:var(--text2);opacity:.7;margin-left:6px">‚Ü≥ ${esc(pw)}</span>`;
  })() : '';
  return `<div class="vcard${depthClass}">
    <div class="vcard-bar" style="background:${lgrad}"></div>
    <div class="vcard-badge" style="background:${lgrad};color:${ltxt}">${esc(lname)}</div>
    <div class="vcard-body">
      <div class="vcard-title">
        <span class="word">${wdHl}</span>${mng?`<span class="meaning"> ‚Äî ${mngHl}</span>`:''}${familyIcon}${depth===0&&w.parentId?parentInfo:''}
      </div>
      ${(phonetic||spkBtn)?`<div style="display:flex;align-items:center;gap:7px;margin-top:3px">${phonetic}${spkBtn}</div>`:''}
      <div class="vcard-meta">${ttags}${ctags}${dt?`<span class="dtxt">${dt}</span>`:''}</div>
      ${w.createdAt?`<div class="fbar-wrap">${fr.color==='rainbow'?`<div class="fbar rb-bg" style="width:${fr.w};max-width:80px"></div><span class="flbl rb-txt">${fr.label}</span>`:`<div class="fbar" style="background:${fr.color};width:${fr.w};max-width:80px"></div><span class="flbl" style="color:${fr.color}">${fr.label}</span>`}</div>`:''}
    </div>
    <div class="cactions">
      <button class="iBtn" title="Th√™m t·ª´ cha m·ªõi (Word Family)" onclick="openAddParent('${w.id}','${lid}')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg>
      </button>
      <button class="iBtn ${w.parentId?'wf-has-parent':''}" title="G·∫Øn t·ª´ cha c√≥ s·∫µn (Word Family)" onclick="openSetParentModal('${w.id}','${lid}')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      </button>
      <button class="iBtn" title="S·ª≠a" onclick="openEdit('${w.id}','${lid}')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
      <button class="iBtn del" title="X√≥a" onclick="confirmDel('${w.id}','${lid}')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </button>
    </div>
  </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEVEL SELECT & PAGINATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.selLevel = function(id){
  S.searchMode=false; S.searchQ='';
  if(_autoPlayTimer){clearTimeout(_autoPlayTimer);_autoPlayTimer=null;}
  if(typeof _historyTimer !== 'undefined' && _historyTimer){clearTimeout(_historyTimer);_historyTimer=null;} // TH√äM D√íNG N√ÄY
  document.getElementById('gSearch').value='';
  S.activeLevel=id;
  S.shownLimit = PAGE;
  const lvl=S.levels.find(l=>l.id===id);
  setLevelColor(lc(id), lvl?.color2);

  // K√©o Data t·ª´ RAM ra d√πng ngay l·∫≠p t·ª©c
  S.shown = getLevelData(id).slice(0, S.shownLimit);
  rMain(); rSidebar();
};

window.loadMore = function(){
  if(!S.activeLevel) return;
  S.shownLimit += PAGE;
  S.shown = getLevelData(S.activeLevel).slice(0, S.shownLimit);
  rMain();
};

window.handleSort = function(v){
  S.sortBy=v;
  if(!S.activeLevel) return;
  S.shownLimit = PAGE; // Reset v·ªÅ trang 1
  S.shown = getLevelData(S.activeLevel).slice(0, S.shownLimit);
  rMain();
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBAL SEARCH HANDLERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleClearBtn(inp, btnId) {
  const b = document.getElementById(btnId);
  if (b) b.classList.toggle('vis', inp.value.length > 0);
}
window.onSbSearch = function(inp) {
  toggleClearBtn(inp, 'gSearchClear');
  dbSearch(inp.value, 'gSearch');
};
window.syncMobSearch = function(inp) {
  const v = inp.value;
  const ds = document.getElementById('gSearch');
  if (ds) { ds.value = v; toggleClearBtn(ds, 'gSearchClear'); }
  toggleClearBtn(inp, 'gSearchMobClear');
  dbSearch(v, 'gSearchMob');
};
let tempSearchHistory = []; // M·∫£ng l∆∞u l·ªãch s·ª≠ t·∫°m tr√™n RAM

function updateHistoryUI() {
  let dl = document.getElementById('searchHistoryList');
  if (!dl) {
    // N·∫øu ch∆∞a c√≥ datalist th√¨ t·∫°o m·ªõi v√† g·∫Øn v√†o body
    dl = document.createElement('datalist');
    dl.id = 'searchHistoryList';
    document.body.appendChild(dl);
  }
  // ƒê·ªï d·ªØ li·ªáu t·ª´ m·∫£ng v√†o datalist
  dl.innerHTML = tempSearchHistory.map(w => `<option value="${esc(w)}"></option>`).join('');
}

let _autoPlayTimer=null;
let _historyTimer=null; // TH√äM BI·∫æN M·ªöI

const dbSearch=debounce((v, srcId)=>{
  if(!v.trim()){ clearSearch(true, srcId||'gSearchMob'); return; }
  S.searchQ=v; S.searchMode=true;
  S.shown = doGlobalSearch(v);
  rMain(); rSidebar();
  requestAnimationFrame(()=>{
    ['gSearchMob','gSearch'].forEach(id=>{
      const e=document.getElementById(id);
      const b=document.getElementById(id==='gSearchMob'?'gSearchMobClear':'gSearchClear');
      if(e&&b) b.classList.toggle('vis',e.value.length>0);
    });
  });
  
  // D·ªçn d·∫πp c·∫£ 2 timer c≈© n·∫øu ng∆∞·ªùi d√πng g√µ ti·∫øp
  if(_autoPlayTimer) clearTimeout(_autoPlayTimer);
  if(_historyTimer) clearTimeout(_historyTimer);

  // 1. PH√ÅT AUDIO (1000ms)
  _autoPlayTimer = setTimeout(()=>{
    const first = S.shown[0];
    if(first && first.audioUrl){
      if(_audioEl){_audioEl.pause();_audioEl=null;document.querySelectorAll('.spk-btn.playing').forEach(b=>b.classList.remove('playing'));}
      _audioEl=new Audio(first.audioUrl);
      _audioEl.play().catch(()=>{});
      _audioEl.onended=()=>{_audioEl=null;};
      _audioEl.onerror=()=>{_audioEl=null;};
    }
  }, 1200);

  // 2. L∆ØU L·ªäCH S·ª¨ T√åM KI·∫æM (1500ms)
  _historyTimer = setTimeout(()=>{
    const q = S.searchQ.trim();
    if (q && !tempSearchHistory.includes(q)) {
      tempSearchHistory.unshift(q); // ƒê·∫©y t·ª´ m·ªõi l√™n ƒë·∫ßu danh s√°ch
      if (tempSearchHistory.length > 3) tempSearchHistory.pop(); // Gi·ªØ t·ªëi ƒëa 3 t·ª´ g·∫ßn nh·∫•t
      updateHistoryUI(); // C·∫≠p nh·∫≠t l·∫°i thanh g·ª£i √Ω
    }
  }, 1700);

},300);
  
window.clearSearch=function(keepFocus, focusId){
  if(_autoPlayTimer){clearTimeout(_autoPlayTimer);_autoPlayTimer=null;}
  if(_historyTimer){clearTimeout(_historyTimer);_historyTimer=null;} // TH√äM D√íNG N√ÄY
  S.searchMode=false; S.searchQ='';
  ['gSearch','gSearchMob'].forEach(id=>{
    const e=document.getElementById(id); if(e) e.value='';
  });
  ['gSearchClear','gSearchMobClear'].forEach(id=>{
    const b=document.getElementById(id); if(b) b.classList.remove('vis');
  });
  if(S.activeLevel){ S.shownLimit=PAGE; S.shown=getLevelData(S.activeLevel).slice(0,S.shownLimit); }
  rMain(); rSidebar();
  if(keepFocus!==false) requestAnimationFrame(()=>{
    const el=document.getElementById(focusId||'gSearch');
    if(el){ el.focus(); const n=el.value.length; el.setSelectionRange(n,n); }
  });
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _audioEl=null;

window.playAudio=function(e,url){
  e.stopPropagation();
  const btn=e.currentTarget;
  if(_audioEl){_audioEl.pause();_audioEl=null;document.querySelectorAll('.spk-btn.playing').forEach(b=>b.classList.remove('playing'));}
  _audioEl=new Audio(url);
  btn.classList.add('playing');
  _audioEl.play().catch(()=>{});
  _audioEl.onended=()=>{btn.classList.remove('playing');_audioEl=null;};
  _audioEl.onerror=()=>{btn.classList.remove('playing');_audioEl=null;toast('Kh√¥ng th·ªÉ ph√°t √¢m thanh','err');};
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD / EDIT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let mWT=[],mTags=[],mColor='';

window.openAdd=function(){
  S.editWord=null; S.editLevel=S.activeLevel;
  mWT=[]; mTags=[]; mColor=lc(S.activeLevel);
  showWordModal({});
};
window.openEdit=function(id,lid){
  // T√¨m trong Local DB
  const w = (S.localDB[lid]||[]).find(x=>x.id===id) || S.shown.find(x=>x.id===id);
  if(!w)return;
  S.editWord=w; S.editLevel=lid;
  mWT=Array.isArray(w.wordTypes)?[...w.wordTypes]:(w.wordType?[w.wordType]:[]);
  mTags=[...(w.tags||[])];
  mColor=w.color||lc(lid);
  showWordModal(w);
};

function showWordModal(w){
  const isEdit=!!w.id;
  const tLid=w._forceLevel||(isEdit?S.editLevel:(S.activeLevel||S.levels[0]?.id));
  const dv=w.createdAt?new Date(w.createdAt).toISOString().split('T')[0]:new Date().toISOString().split('T')[0];
  document.getElementById('wModal').innerHTML=`<div class="modal">
    <div class="modal-title">${isEdit?'‚úèÔ∏è S·ª≠a t·ª´ v·ª±ng':'‚ú® Th√™m t·ª´ m·ªõi'}</div>
    <div class="fg">
      <label class="flabel">N·ªôi dung <span style="color:var(--red)">*</span></label>
      <textarea class="ftarea" id="mCont" placeholder="word (adj): nghƒ©a ti·∫øng Vi·ªát">${esc(w.content||'')}</textarea>
    </div>
    <div class="frow">
      <div class="fg">
        <label class="flabel">Phi√™n √¢m</label>
        <input class="finput" id="mPhonetic" placeholder="/Ààw…úÀêd/" value="${esc(w.phonetic||'')}" style="font-family:'DM Mono',monospace;font-style:italic"/>
      </div>
      <div class="fg">
        <label class="flabel">Link √¢m thanh (URL)</label>
        <input class="finput" id="mAudio" placeholder="https://..." value="${esc(w.audioUrl||'')}"/>
      </div>
    </div>
    <div class="frow">
      <div class="fg">
        <label class="flabel">C·∫•p ƒë·ªô</label>
        <select class="fselect" id="mLvl">${S.levels.map(l=>`<option value="${l.id}" ${tLid===l.id?'selected':''}>${esc(l.name)}</option>`).join('')}</select>
      </div>
      <div class="fg">
        <label class="flabel">Ng√†y th√™m</label>
        <input type="date" class="finput" id="mDate" value="${dv}" style="font-family:'DM Mono',monospace;font-size:13px"/>
      </div>
    </div>
    <div class="fg">
      <label class="flabel">Lo·∫°i t·ª´ <span style="color:var(--text2);font-size:10px;font-weight:400;text-transform:none">(ch·ªçn nhi·ªÅu)</span>
        <button onclick="addWType()" style="background:none;border:none;color:var(--accent);font-size:11px;cursor:pointer;margin-left:6px;text-transform:none">+ Th√™m lo·∫°i</button>
      </label>
      <div class="wt-grid" id="wtGrid">${rWTChips()}</div>
    </div>


    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeWM()">H·ªßy</button>
      <button class="btn btn-primary" onclick="saveWord()">${isEdit?'L∆∞u thay ƒë·ªïi':'Th√™m t·ª´'}</button>
    </div>
  </div>`;
  document.getElementById('wModal').classList.add('open');
}

// Th√™m 2 th·∫ª n√†y v√†o d√≤ng 746 n·∫øu c·∫ßn (kh√¥ng x√≥a)
    // <div class="fg">
    //   <label class="flabel">Th·∫ª t√πy ch·ªânh</label>
    //   <div class="tags-wrap" id="tWrap" onclick="document.getElementById('tInp').focus()">
    //     ${rTagChips()}
    //     <input id="tInp" class="tag-inp" placeholder="Nh·∫≠p tag, Enter ƒë·ªÉ th√™m..." onkeydown="handleTagKey(event)"/>
    //   </div>
    // </div>
    // <div class="fg">
    //   <label class="flabel">M√†u s·∫Øc <span style="color:var(--text2);font-size:10px;font-weight:400;text-transform:none">(m√†u m·ª•c ƒë∆∞·ª£c ∆∞u ti√™n hi·ªÉn th·ªã)</span></label>
    //   <div class="cprow">
    //     ${PAL.map(c=>`<div class="cswatch ${mColor===c?'sel':''}" style="background:${c}" onclick="pickColor('${c}')"></div>`).join('')}
    //     <input type="color" value="${mColor}" oninput="pickColor(this.value)" style="width:34px;height:24px;padding:0;border-radius:7px;cursor:pointer;border:1px solid var(--border);background:var(--surface2)"/>
    //   </div>
    // </div>

function rWTChips(){
  return S.wtypes.map(t=>{
    const c=wtColor(t);
    const sel=mWT.includes(t);
    const style=sel
      ?`background:${c.bg};border-color:${c.border};color:${c.text}`
      :`background:var(--surface2);border-color:var(--border);color:var(--text2)`;
    const xBtn=sel?`<button class="x-btn" onclick="togWT(event,'${esc(t)}')" title="B·ªè ch·ªçn">√ó</button>`:'';
    return `<span class="wt-chip ${sel?'sel':''}" style="${style}" onclick="togWT(event,'${esc(t)}')">${esc(t)}${xBtn}</span>`;
  }).join('')+`<button class="wt-add" onclick="addWType()">+ Th√™m</button>`;
}
function rTagChips(){
  return mTags.map((t,i)=>`<span class="tag-chip">${esc(t)}<button onclick="rmTag(${i})">√ó</button></span>`).join('');
}

window.togWT=function(e,t){
  e.stopPropagation();
  mWT=mWT.includes(t)?mWT.filter(x=>x!==t):[...mWT,t];
  const g=document.getElementById('wtGrid');
  if(g) g.innerHTML=rWTChips();
};
window.rmTag=function(i){ mTags.splice(i,1); refreshTW(); };
function refreshTW(){
  const w=document.getElementById('tWrap');
  if(w) w.innerHTML=rTagChips()+`<input id="tInp" class="tag-inp" placeholder="Nh·∫≠p tag, Enter ƒë·ªÉ th√™m..." onkeydown="handleTagKey(event)"/>`;
}
window.handleTagKey=function(e){
  if((e.key==='Enter'||e.key===',')&&e.target.value.trim()){
    e.preventDefault(); mTags.push(e.target.value.trim()); refreshTW();
    document.getElementById('tInp')?.focus();
  }
};
window.pickColor=function(c){
  mColor=c;
  document.querySelectorAll('#wModal .cswatch').forEach(s=>s.classList.toggle('sel',s.style.background===c||s.style.backgroundColor===c));
};
window.addWType=function(){
  const n=prompt('T√™n lo·∫°i t·ª´ m·ªõi:');
  if(n&&n.trim()&&!S.wtypes.includes(n.trim())){
    S.wtypes.push(n.trim());
    localStorage.setItem('vv_wtypes',JSON.stringify(S.wtypes));
    const g=document.getElementById('wtGrid');
    if(g) g.innerHTML=rWTChips();
  }
};
window.closeWM=function(){
  document.getElementById('wModal').classList.remove('open');
  _pendingChildId=null; _pendingChildLid=null;
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORD FAMILY ‚Äî ADD NEW PARENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _pendingChildId = null, _pendingChildLid = null;

window.openAddParent = function(childId, childLid){
  _pendingChildId = childId;
  _pendingChildLid = childLid;
  S.editWord = null;
  S.editLevel = childLid;
  mWT=[]; mTags=[]; mColor=lc(childLid);
  // M·ªü modal v·ªõi c·∫•p ƒë·ªô hi·ªán t·∫°i c·ªßa t·ª´ con ‚Äî user t·ª± ch·ªçn c·∫•p cha
  showWordModal({_forceLevel: childLid});
  requestAnimationFrame(()=>{
    const modal = document.querySelector('#wModal .modal');
    if(!modal) return;
    let childName='';
    for(const l of S.levels){ const cw=(S.localDB[l.id]||[]).find(x=>x.id===childId); if(cw){childName=(cw.content||'').split(':')[0].trim();break;} }
    // Hint th√¥ng tin
    const hint = document.createElement('div');
    hint.style.cssText='background:color-mix(in srgb,var(--accent) 12%,var(--surface2));border:1px solid color-mix(in srgb,var(--accent) 35%,var(--border));border-radius:9px;padding:8px 12px;font-size:12px;color:var(--accent);margin-bottom:6px;display:flex;align-items:center;gap:8px';
    hint.innerHTML=`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>üåø T·ª´ m·ªõi n√†y s·∫Ω th√†nh <strong>t·ª´ cha</strong> c·ªßa "<strong>${esc(childName)}</strong>"`;
    const titleEl = modal.querySelector('.modal-title');
    if(titleEl) titleEl.after(hint);
    // C·∫£nh b√°o ƒë·ªè khi ch·ªçn l·∫°i c·∫•p ƒë·ªô c·ªßa t·ª´ con
    const lvlSel = modal.querySelector('#mLvl');
    const warnEl = document.createElement('div');
    warnEl.id = 'apLvlWarn';
    warnEl.style.cssText='display:none;background:color-mix(in srgb,var(--red) 12%,var(--surface2));border:1px solid color-mix(in srgb,var(--red) 50%,var(--border));border-radius:8px;padding:7px 11px;font-size:12px;color:var(--red);margin-top:5px;display:none;align-items:center;gap:7px';
    warnEl.innerHTML=`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>T·ª´ cha n√™n ·ªü c·∫•p ƒë·ªô cao h∆°n t·ª´ con (<strong>${esc(S.levels.find(l=>l.id===childLid)?.name||childLid)}</strong>)!`;
    if(lvlSel){
      lvlSel.parentNode.appendChild(warnEl);
      // Hi·ªán c·∫£nh b√°o ngay t·ª´ ƒë·∫ßu v√¨ c·∫•p m·∫∑c ƒë·ªãnh l√† c·∫•p c·ªßa t·ª´ con
      warnEl.style.display = 'flex';
      lvlSel.style.borderColor = 'var(--red)';
      lvlSel.addEventListener('change', function(){
        const show = this.value === childLid;
        warnEl.style.display = show ? 'flex' : 'none';
        lvlSel.style.borderColor = show ? 'var(--red)' : '';
      });
    }
  });
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORD FAMILY ‚Äî SET EXISTING PARENT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _spChildId = null, _spChildLid = null;

window.openSetParentModal = function(childId, childLid){
  _spChildId = childId; _spChildLid = childLid;
  let childName='';
  for(const l of S.levels){ const cw=(S.localDB[l.id]||[]).find(x=>x.id===childId); if(cw){childName=(cw.content||'').split(':')[0].trim();break;} }
  const overlay = document.getElementById('spModal');
  overlay.innerHTML=`<div class="sp-modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px">
      <div style="font-family:'Playfair Display',serif;font-size:16px">üåø G·∫Øn t·ª´ cha cho "<strong>${esc(childName)}</strong>"</div>
      <button onclick="closeSpModal()" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;width:28px;height:28px;cursor:pointer;color:var(--text2);display:flex;align-items:center;justify-content:center"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <button class="sp-none-btn" onclick="setParentId('${childId}','${childLid}','');closeSpModal();toast('ƒê√£ ƒë·∫∑t l√† t·ª´ ƒë·ªôc l·∫≠p','ok')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      None ‚Äî ƒê·∫∑t l√† t·ª´ ƒë·ªôc l·∫≠p (x√≥a cha hi·ªán t·∫°i)
    </button>
    <div class="sp-search-wrap">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="spInp" class="sp-inp" placeholder="T√¨m t·ª´ cha‚Ä¶ (g√µ √≠t nh·∫•t 1 k√Ω t·ª±)" oninput="spSearch(this.value,'${childId}')" autocomplete="off"/>
    </div>
    <div class="sp-results" id="spResults"><div class="sp-hint">G√µ ƒë·ªÉ t√¨m t·ª´ mu·ªën ƒë·∫∑t l√†m cha</div></div>
  </div>`;
  overlay.classList.add('open');
  requestAnimationFrame(()=>document.getElementById('spInp')?.focus());
};

window.closeSpModal = function(){ document.getElementById('spModal').classList.remove('open'); };

window.spSearch = function(q, excludeId){
  const res = document.getElementById('spResults');
  if(!res) return;
  const trimQ = q.trim().toLowerCase();
  if(!trimQ){ res.innerHTML='<div class="sp-hint">G√µ ƒë·ªÉ t√¨m t·ª´ mu·ªën ƒë·∫∑t l√†m cha</div>'; return; }
  // Build set of IDs that already have children (marked with üåø) ‚Äî exclude them
  const idsWithChildren = new Set();
  for(const l of S.levels){
    for(const w of (S.localDB[l.id]||[])){
      if(w.parentId) idsWithChildren.add(w.parentId);
    }
  }
  let hits = [];
  for(const l of S.levels){
    for(const w of (S.localDB[l.id]||[])){
      if(w.id===excludeId) continue;
      if(idsWithChildren.has(w.id)) continue; // ·∫®n t·ª´ ƒë√£ c√≥ con (üåø)
      if((w.content||'').toLowerCase().includes(trimQ)) hits.push({w,l});
    }
  }
  hits.sort((a,b)=>{
    const ai=(a.w.content||'').toLowerCase().indexOf(trimQ);
    const bi=(b.w.content||'').toLowerCase().indexOf(trimQ);
    return ai!==bi?ai-bi:(b.w.createdAt||0)-(a.w.createdAt||0);
  });
  hits = hits.slice(0,30);
  if(!hits.length){ res.innerHTML='<div class="sp-hint">Kh√¥ng t√¨m th·∫•y t·ª´ n√†o</div>'; return; }
  res.innerHTML = hits.map(({w,l})=>{
    const wd=(w.content||'').split(':')[0].trim();
    const mn=(w.content||'').includes(':')?(w.content||'').split(':').slice(1).join(':').trim():'';
    return `<div class="sp-item" onclick="setParentId('${_spChildId}','${_spChildLid}','${w.id}');closeSpModal();toast('ƒê√£ g·∫Øn t·ª´ cha ‚úì','ok')">
      <div style="flex:1;min-width:0">
        <div class="sp-item-word">${esc(wd)}${mn?`<span style="color:var(--text2);font-weight:400"> ‚Äî ${esc(mn.slice(0,40))}${mn.length>40?'‚Ä¶':''}</span>`:''}</div>
        <div class="sp-item-meta">[${l.id}] ${l.name}</div>
      </div>
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </div>`;
  }).join('');
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SET PARENT HELPER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.setParentId = async function(childId, childLid, parentId){
  // Find the child word in localDB
  let found = false;
  for(const l of S.levels){
    const arr = S.localDB[l.id]||[];
    const idx = arr.findIndex(x=>x.id===childId);
    if(idx>-1){
      arr[idx].parentId = parentId;
      arr[idx].updatedAt = Date.now();
      // Write to Firebase
      try{
        await updateDoc(doc(db,col(l.id),childId),{parentId,updatedAt:arr[idx].updatedAt});
      }catch(e){ toast('L·ªói c·∫≠p nh·∫≠t: '+e.message,'err'); return; }
      found=true; break;
    }
  }
  if(!found) return;
  saveLocalDB();
  // Refresh UI
  if(S.searchMode) S.shown=doGlobalSearch(S.searchQ);
  else if(S.activeLevel) S.shown=getLevelData(S.activeLevel).slice(0,S.shownLimit);
  rMain();
};;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE LOGIC (WRITE-THROUGH) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.saveWord=async function(){
  const content=document.getElementById('mCont')?.value?.trim();
  if(!content){toast('Vui l√≤ng nh·∫≠p n·ªôi dung','err');return;}
  const lid=document.getElementById('mLvl')?.value||S.activeLevel;
  const dv=document.getElementById('mDate')?.value;
  // T·ª´ m·ªõi: lu√¥n d√πng Date.now() ƒë·ªÉ gi·ªØ th·ª© t·ª± ch√≠nh x√°c theo gi·ªù th√™m v√†o.
  // Ch·ªâ parse ng√†y t·ª´ input khi ƒëang edit (ƒë·ªÉ kh√¥ng thay ƒë·ªïi ng√†y g·ªëc).
  const createdAt=S.editWord?(dv?new Date(dv).getTime():Date.now()):Date.now();
  const phonetic=document.getElementById('mPhonetic')?.value?.trim()||'';
  const audioUrl=document.getElementById('mAudio')?.value?.trim()||'';
  // parentId is managed via Word Family buttons, preserve existing value on edit
  const existingParentId = S.editWord?.parentId||'';
  const data={content,wordTypes:[...mWT],tags:[...mTags],color:mColor,createdAt,updatedAt:Date.now(),phonetic,audioUrl,parentId:existingParentId};
  
  try{
    let affectedLids=[lid]; // C√°c level c·∫ßn refresh UI
    if(S.editWord){
      const oldLid=S.editLevel;
      const newLid=lid;
      affectedLids=[oldLid,newLid];
      if(oldLid!==newLid){
        // ƒê·ªïi level: x√≥a ·ªü level c≈©, th√™m v√†o level m·ªõi
        await deleteDoc(doc(db,col(oldLid),S.editWord.id));
        const ref=await addDoc(collection(db,col(newLid)),data);
        const nw={id:ref.id,...data,_lid:newLid};
        if(S.localDB[oldLid]) S.localDB[oldLid]=S.localDB[oldLid].filter(x=>x.id!==S.editWord.id);
        S.counts[oldLid]=Math.max(0,(S.counts[oldLid]||1)-1);
        if(!S.localDB[newLid]) S.localDB[newLid]=[];
        S.localDB[newLid].push(nw);
        S.counts[newLid]=(S.counts[newLid]||0)+1;
      } else {
        // C√πng level: update b√¨nh th∆∞·ªùng
        await updateDoc(doc(db,col(oldLid),S.editWord.id),data);
        if(S.localDB[oldLid]){
          const i=S.localDB[oldLid].findIndex(x=>x.id===S.editWord.id);
          if(i>-1) S.localDB[oldLid][i]={...S.localDB[oldLid][i],...data,_lid:oldLid};
        }
      }
      localStorage.setItem('vv_counts',JSON.stringify(S.counts));
      [oldLid,newLid].forEach(id=>{ const el=document.getElementById('cnt_'+id); if(el) el.textContent=S.counts[id]; });
      toast('ƒê√£ c·∫≠p nh·∫≠t ‚úì','ok');
    }else{
      // 1. Th√™m m·ªõi v√†o Firebase
      const ref=await addDoc(collection(db,col(lid)),data);
      const nw={id:ref.id,...data,_lid:lid};
      // 2. Th√™m v√†o RAM LocalDB & Storage
      if(!S.localDB[lid]) S.localDB[lid] = [];
      S.localDB[lid].push(nw);
      
      S.counts[lid]=(S.counts[lid]||0)+1;
      localStorage.setItem('vv_counts',JSON.stringify(S.counts));
      const el=document.getElementById('cnt_'+lid); if(el) el.textContent=S.counts[lid];
      toast('ƒê√£ th√™m t·ª´ m·ªõi ‚úì','ok');

      // N·∫øu ƒëang th√™m cha m·ªõi qua openAddParent, g·∫Øn parentId cho con ngay
      if(_pendingChildId){
        const cId=_pendingChildId, cLid=_pendingChildLid;
        _pendingChildId=null; _pendingChildLid=null;
        // C·∫≠p nh·∫≠t parentId c·ªßa con = id t·ª´ v·ª´a th√™m
        for(const l of S.levels){
          const arr=S.localDB[l.id]||[];
          const idx=arr.findIndex(x=>x.id===cId);
          if(idx>-1){
            arr[idx].parentId=ref.id;
            arr[idx].updatedAt=Date.now();
            try{ await updateDoc(doc(db,col(l.id),cId),{parentId:ref.id,updatedAt:arr[idx].updatedAt}); }
            catch(e){ toast('L·ªói g·∫Øn cha: '+e.message,'err'); }
            break;
          }
        }
      }
    }
    
    saveLocalDB();
    if(S.searchMode){
      // Trong search mode: re-run search ƒë·ªÉ c·∫≠p nh·∫≠t k·∫øt qu·∫£
      S.shown = doGlobalSearch(S.searchQ);
    } else if(affectedLids.includes(S.activeLevel)){
      // Refresh shown n·∫øu ƒëang xem level b·ªã ·∫£nh h∆∞·ªüng
      S.shown = getLevelData(S.activeLevel).slice(0, S.shownLimit);
    }
    closeWM(); rMain(); rSidebar();
  }catch(e){toast('L·ªói: '+e.message,'err');}
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DELETE (WRITE-THROUGH) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let delTarget=null;
window.confirmDel=function(id,lid){delTarget={id,lid};document.getElementById('cfmModal').classList.add('open');};
window.closeCfm=function(){document.getElementById('cfmModal').classList.remove('open');delTarget=null;};
window.doDelete=async function(){
  if(!delTarget)return;
  const{id,lid}=delTarget;
  try{
    await deleteDoc(doc(db,col(lid),id));
    
    if(S.localDB[lid]) S.localDB[lid] = S.localDB[lid].filter(x=>x.id!==id);
    saveLocalDB();

    S.counts[lid]=Math.max(0,(S.counts[lid]||1)-1);
    localStorage.setItem('vv_counts',JSON.stringify(S.counts));
    const el=document.getElementById('cnt_'+lid); if(el) el.textContent=S.counts[lid];
    
    if(!S.searchMode) S.shown = getLevelData(lid).slice(0, S.shownLimit);
    else S.shown = S.shown.filter(x=>x.id!==id);

    closeCfm(); rMain(); rSidebar(); toast('ƒê√£ x√≥a ‚úì','ok');
  }catch(e){toast('L·ªói: '+e.message,'err');}
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.openSettings=function(){
  document.getElementById('setModal').innerHTML=`<div class="modal" style="width:580px">
    <div class="modal-title">‚öôÔ∏è C√†i ƒë·∫∑t c·∫•p ƒë·ªô</div>
    <div style="display:grid;grid-template-columns:1fr 32px 32px 32px 32px;align-items:center;gap:8px;padding:0 0 6px;border-bottom:1px solid var(--border);margin-bottom:4px">
      <span style="font-size:10px;color:var(--text2);font-weight:600;letter-spacing:.5px;text-transform:uppercase">T√™n c·∫•p ƒë·ªô</span>
      <span style="font-size:9px;color:var(--text2);text-align:center">M√†u 1</span>
      <span style="font-size:9px;color:var(--text2);text-align:center">M√†u 2</span>
      <span style="font-size:9px;color:var(--text2);text-align:center">Ch·ªØ</span>
      <span></span>
    </div>
    <div id="leList">
      ${S.levels.map(l=>{
        const c1=l.color||'#4a9eff', c2=l.color2||c1, ct=l.textColor||getContrastColor(c1);
        return `<div class="le-item" data-id="${l.id}" style="display:grid;grid-template-columns:1fr 32px 32px 32px 32px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
          <input class="ni" value="${esc(l.name)}" placeholder="T√™n c·∫•p ƒë·ªô"/>
          <div style="position:relative;display:flex;justify-content:center">
            <div class="lc-btn lc-btn1" style="background:${c1}" data-color="${c1}" title="M√†u 1" onclick="toggleCP(this,'${l.id}','color1')"></div>
          </div>
          <div style="position:relative;display:flex;justify-content:center">
            <div class="lc-btn lc-btn2" style="background:${c2}" data-color="${c2}" title="M√†u 2" onclick="toggleCP(this,'${l.id}','color2')"></div>
          </div>
          <div style="position:relative;display:flex;justify-content:center">
            <div class="lc-btn lc-btntxt" style="background:${ct};border:2px solid var(--border)" data-color="${ct}" title="M√†u ch·ªØ" onclick="toggleCP(this,'${l.id}','textColor')">
              <span style="font-size:9px;font-weight:700;color:${getContrastColor(ct)}">A</span>
            </div>
          </div>
          <button class="iBtn del" onclick="delLevel('${l.id}')" ${S.levels.length<=1?'disabled':''}>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
          </button>
        </div>`;
      }).join('')}
    </div>
    <button class="btn btn-ghost" style="width:100%;margin-top:12px;justify-content:center" onclick="addLevel()">+ Th√™m c·∫•p ƒë·ªô</button>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeSet()">H·ªßy</button>
      <button class="btn btn-primary" onclick="saveSet()">L∆∞u</button>
    </div>
  </div>`;
  document.getElementById('setModal').classList.add('open');
};

window.toggleCP=function(btn,lid,field){
  document.querySelectorAll('.cpop').forEach(p=>p.remove());
  // field: 'color1','color2','textColor' - cho ph√©p ph√¢n bi·ªát lo·∫°i m√†u ƒëang ch·ªçn
  const curField = field||'color1';
  const item=document.querySelector(`[data-id="${lid}"]`);
  let cur='#4a9eff';
  if(item){
    if(curField==='color1') cur=item.querySelector('.lc-btn1')?.dataset.color||'#4a9eff';
    else if(curField==='color2') cur=item.querySelector('.lc-btn2')?.dataset.color||cur;
    else if(curField==='textColor') cur=item.querySelector('.lc-btntxt')?.dataset.color||'#ffffff';
  }
  const pop=document.createElement('div');
  pop.className='cpop';
  pop.innerHTML=PAL.map(c=>`<div class="cswatch ${cur===c?'sel':''}" style="background:${c};width:22px;height:22px;border-radius:6px" onclick="applyLC(event,'${c}','${lid}','${curField}')"></div>`).join('')
    +`<input type="color" value="${cur}" oninput="applyLC(event,this.value,'${lid}','${curField}')" style="width:100%;height:26px;border:none;border-radius:6px;cursor:pointer;margin-top:4px"/>`;
  document.body.appendChild(pop);
  // T√≠nh v·ªã tr√≠ fixed d·ª±a tr√™n button
  const rect=btn.getBoundingClientRect();
  let top=rect.bottom+6, left=rect.left;
  // ƒê·∫£m b·∫£o kh√¥ng ra ngo√†i viewport
  if(left+220>window.innerWidth) left=window.innerWidth-228;
  if(top+240>window.innerHeight) top=rect.top-246;
  pop.style.top=top+'px'; pop.style.left=left+'px';
  setTimeout(()=>document.addEventListener('click',function cl(e){if(!pop.contains(e.target)&&e.target!==btn){pop.remove();document.removeEventListener('click',cl);}},10));
};
window.applyLC=function(e,c,lid,field){
  e.stopPropagation();
  const item=document.querySelector(`[data-id="${lid}"]`);
  if(item){
    const f=field||'color1';
    if(f==='color1'){
      const b=item.querySelector('.lc-btn1'); if(b){b.style.background=c;b.dataset.color=c;}
    } else if(f==='color2'){
      const b=item.querySelector('.lc-btn2'); if(b){b.style.background=c;b.dataset.color=c;}
    } else if(f==='textColor'){
      const b=item.querySelector('.lc-btntxt'); if(b){b.style.background=c;b.dataset.color=c;b.style.color=getContrastColor(c);}
    }
    // C·∫≠p nh·∫≠t preview gradient tr√™n dot
    const btn1=item.querySelector('.lc-btn1'),btn2=item.querySelector('.lc-btn2');
    if(btn1&&btn2){
      const c1=btn1.dataset.color, c2=btn2.dataset.color;
      const preview=item.querySelector('.grad-preview');
      if(preview) preview.style.background=`linear-gradient(135deg,${c1},${c2})`;
    }
    item.querySelectorAll('.cswatch').forEach(s=>s.classList.toggle('sel',s.style.background===c||s.style.backgroundColor===c));
  }
};
window.addLevel=function(){
  S.levels.push({id:'L'+Date.now(),name:'C·∫•p m·ªõi',color:PAL[Math.floor(Math.random()*PAL.length)]});
  openSettings();
};
window.delLevel=function(id){
  if(S.levels.length<=1)return;
  if(!confirm('X√≥a c·∫•p ƒë·ªô n√†y? D·ªØ li·ªáu trong Firestore kh√¥ng b·ªã x√≥a.'))return;
  S.levels=S.levels.filter(l=>l.id!==id);
  if(S.activeLevel===id){S.activeLevel=S.levels[0]?.id||null;S.shown=[];}
  openSettings();
};
window.saveSet=function(){
  document.querySelectorAll('#leList .le-item').forEach(item=>{
    const id=item.dataset.id,l=S.levels.find(x=>x.id===id);
    if(l){
      l.name=item.querySelector('.ni').value.trim()||l.name;
      l.color=item.querySelector('.lc-btn1')?.dataset.color||l.color;
      l.color2=item.querySelector('.lc-btn2')?.dataset.color||l.color;
      l.textColor=item.querySelector('.lc-btntxt')?.dataset.color||'#ffffff';
    }
  });
  localStorage.setItem('vv_levels',JSON.stringify(S.levels));
  closeSet(); rMain(); rSidebar(); toast('ƒê√£ l∆∞u c√†i ƒë·∫∑t ‚úì','ok');
};
window.closeSet=function(){document.getElementById('setModal').classList.remove('open');};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE DRAWER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rDrawer(){
  const nav=document.getElementById('drawerNav'); if(!nav) return;
  nav.innerHTML=S.levels.map(l=>{
    const cnt=S.counts[l.id]!==undefined?S.counts[l.id]:'‚Ä¶';
    const active=S.activeLevel===l.id&&!S.searchMode;
    const dotStyle=l.color2?`background:linear-gradient(135deg,${l.color},${l.color2})`:`background:${l.color}`;
    return `<button class="lvl-btn ${active?'active':''}" onclick="selLevel('${l.id}');closeDrawer()">
      <span class="dot" style="${dotStyle}"></span><span>${esc(l.name)}</span>
      <span class="cnt">${cnt}</span></button>`;
  }).join('');
}
window.openDrawer=function(){
  rDrawer(); updateTotalUI();
  document.getElementById('drawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
  document.body.style.overflow='hidden';
};
window.closeDrawer=function(){
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
  document.body.style.overflow='';
};
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toast(msg,type=''){
  const el=Object.assign(document.createElement('div'),{className:`toast ${type}`,textContent:msg});
  document.getElementById('toastC').appendChild(el);
  setTimeout(()=>el.remove(),3100);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('click',e=>{
  ['wModal','setModal','cfmModal','spModal'].forEach(id=>{
    const el=document.getElementById(id);
    if(el&&e.target===el) el.classList.remove('open');
  });
});

// search input handled via oninput attributes

async function init(){
  rSidebar(); 
  
  // Render ngay l·∫≠p t·ª©c d·ªØ li·ªáu ƒëang c√≥ d∆∞·ªõi RAM (0 ms)
  if(S.levels.length) selLevel(S.levels[0].id);
  
  // Ch·∫°y ng·∫ßm vi·ªác ƒë·ªìng b·ªô v·ªõi Firebase (Kh√¥ng l√†m ƒë∆° m√†n h√¨nh)
  for(const l of S.levels) {
    syncLevel(l.id);
  }
}
init();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HTML ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app">
  <aside class="sidebar">
    <div class="logo">ThankVocab<span>ƒê√¢u c√≥ ti·∫øng Anh, ƒë√≥ c√≥ Thanh</span></div>

    <div class="total-row" id="totalRow">
      <span class="total-lbl">T·ªïng c·ªông</span>
      <span class="total-val" id="totalVal">‚Ä¶ t·ª´</span>
    </div>

    <div class="sb-search">
      <div class="sb-search-wrap">
        <svg class="s-ico" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input id="gSearch" type="text" placeholder="T√¨m to√†n b·ªô t·ª´ v·ª±ng‚Ä¶" oninput="onSbSearch(this)" autocomplete="off" list="searchHistoryList"/>
        <button class="s-clear" id="gSearchClear" onclick="clearSearch(true,'gSearch')" title="X√≥a">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">C·∫•p ƒë·ªô</div>
      <div id="lvlNav"></div>
    </div>

    <div class="sb-bottom" style="display: flex; flex-direction: column; gap: 10px;">
      <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px; font-size:14px; box-shadow: 0 4px 14px rgba(91, 141, 238, 0.25);" onclick="openAdd()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Th√™m t·ª´ m·ªõi
      </button>

      <button class="btn btn-ghost" style="width:100%;justify-content:center;font-size:13px" onclick="openSettings()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        C√†i ƒë·∫∑t c·∫•p ƒë·ªô
      </button>
    </div>
  </aside>

  <main class="main" id="mainC">
    <div style="display:flex;align-items:center;justify-content:center;height:100%"><div class="spin"></div></div>
  </main>
</div>

<!-- Modals -->
<div class="moverlay" id="wModal"></div>
<div class="moverlay" id="setModal"></div>
<div class="moverlay" id="cfmModal">
  <div class="modal" style="width:350px">
    <div class="modal-title">üóëÔ∏è X√°c nh·∫≠n x√≥a</div>
    <p style="color:var(--text2);font-size:14px">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·ª´ v·ª±ng n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
    <div class="mfoot">
      <button class="btn btn-ghost" onclick="closeCfm()">H·ªßy</button>
      <button class="btn btn-danger" onclick="doDelete()">X√≥a</button>
    </div>
  </div>
</div>

<div class="moverlay" id="spModal" onclick="if(event.target===this)closeSpModal()"></div>

<div class="toast-c" id="toastC"></div>
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <button class="drawer-close" onclick="closeDrawer()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  <div class="logo" style="padding-right:48px">ThankVocab<span>ƒê√¢u c√≥ ti·∫øng Anh, ƒë√≥ c√≥ Thanh</span></div>
  <div class="total-row"><span class="total-lbl">T·ªïng c·ªông</span><span class="total-val" id="drawerTotalVal">‚Ä¶ t·ª´</span></div>
  <div class="nav-section" style="flex:1;overflow-y:auto"><div class="nav-label">C·∫•p ƒë·ªô</div><div id="drawerNav"></div></div>
  <div style="padding:12px;display:flex;flex-direction:column;gap:10px;border-top:1px solid var(--border)">
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;font-size:14px" onclick="openAdd();closeDrawer()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Th√™m t·ª´ m·ªõi</button>
    <button class="btn btn-ghost" style="width:100%;justify-content:center;font-size:13px" onclick="openSettings();closeDrawer()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>C√†i ƒë·∫∑t c·∫•p ƒë·ªô</button>
  </div>
</div>
</body>

</html>
