<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Launcher Admin</title>
    <link rel="icon" href="https://img.icons8.com/color/48/retro-tv.png" type="image/png">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        /* --- C·∫§U H√åNH CHUNG --- */
        body {
            background-color: #121212;
            color: #eee;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- PH·∫¶N 1: GIAO DI·ªÜN TV (PREVIEW) --- */
        .tv-header-display {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        #appTitleDisplay {
            font-size: 2.5rem; text-transform: uppercase; letter-spacing: 2px;
            color: #4CAF50; text-shadow: 2px 2px 4px #000; margin: 10px 0;
        }
        #appLogoDisplay { max-height: 80px; margin-bottom: 10px; display: none; }

        .control-bar { width: 90%; max-width: 1200px; display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .btn-reload { background: #333; color: #ccc; border: 1px solid #555; padding: 8px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; }

        .grid-container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            width: 90%; max-width: 1200px;
            padding-bottom: 30px;
            border-bottom: 2px solid #333; 
        }

        .card {
            background: #1e1e1e; border: 2px solid #333; border-radius: 10px;
            padding: 15px; text-align: center; color: white; height: 140px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; cursor: pointer;
        }
        .card:focus, .card:hover { background-color: #4CAF50; color: #fff; transform: scale(1.05); }
        .card-icon-img { width: 220px; height: 120px; object-fit: contain; margin-bottom: 10px; }
        .card-icon-text { font-size: 7rem; margin-bottom: 5px; }
        .card-title { font-size: 1.2rem; font-weight: bold; }

        /* --- KHO·∫¢NG TR·ªêNG ƒê·∫®Y ADMIN XU·ªêNG --- */
        .spacer { height: 150px; width: 100%; } 

        /* --- PH·∫¶N 2: ADMIN GIAO DI·ªÜN --- */
        .admin-section {
            width: 90%; max-width: 800px; margin-bottom: 40px;
            padding: 25px; border: 1px solid #444; background: #1a1a1a;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .admin-title {
            color: #2196F3; font-size: 1.3rem; margin-bottom: 15px; 
            text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px;
        }
        
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
        input[type="text"] {
            padding: 12px; background: #222; border: 1px solid #555; 
            color: white; border-radius: 4px; flex: 1; font-size: 1rem;
        }
        input:focus { border-color: #2196F3; outline: none; }

        /* Checkbox Ignore */
        .checkbox-container {
            display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 10px;
            background: #2a2a2a; padding: 10px; border-radius: 4px; border: 1px dashed #555;
        }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #FF9800; }
        .checkbox-label { cursor: pointer; color: #ddd; font-size: 0.95rem; }

        .btn-action {
            padding: 12px 20px; border: none; border-radius: 4px; 
            cursor: pointer; font-weight: bold; color: white; min-width: 80px;
        }
        .btn-save { background-color: #2196F3; }
        .btn-add { background-color: #4CAF50; }
        .btn-cancel { background-color: #777; display: none; }
        .btn-delete { background-color: #f44336; padding: 5px 10px; margin-left: auto; font-size: 0.8rem;}
        .btn-edit { background-color: #FF9800; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;}

        /* G·ª£i √Ω Icon */
        .icon-suggestions { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .suggestion-chip {
            background: #333; padding: 5px 10px; border-radius: 15px; cursor: pointer;
            font-size: 0.85rem; border: 1px solid #444; display: flex; align-items: center; gap: 5px;
        }
        .suggestion-chip:hover { background: #444; border-color: #888; }
        .suggestion-chip img { width: 16px; height: 16px; }

        /* C·∫£nh b√°o Link d√†i */
        .warning-text { color: #FFEB3B; font-size: 0.85rem; margin-top: -5px; margin-bottom: 10px; display: none; font-style: italic; }

        /* Danh s√°ch Item */
        .admin-item-list { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .admin-item-row {
            display: flex; align-items: center; background: #2a2a2a; 
            padding: 10px; border-radius: 4px; gap: 10px; border-left: 3px solid transparent;
        }
        .admin-item-row:hover { background: #333; border-left-color: #2196F3; }
        .item-preview { width: 40px; text-align: center; }
        .item-preview img { width: 30px; height: 30px; object-fit: contain; }
        .item-info { flex: 1; font-size: 0.95rem; color: #ccc; cursor: pointer; }
        .item-info b { color: #fff; }

        /* Block Section */
        .block-section { border-top: 2px dashed #555; margin-top: 20px; padding-top: 20px; }
        .block-title { color: #FF5722; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-chip { background: #333; border: 1px solid #555; padding: 5px 12px; border-radius: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .tag-delete-btn { background: none; border: none; color: #ff5555; font-weight: bold; cursor: pointer; font-size: 1rem; }

        @media (max-width: 600px) {
            .grid-container { grid-template-columns: repeat(2, 1fr); }
            .form-row { flex-direction: column; align-items: stretch; }
            .spacer { height: 50px; }
        }
    </style>
</head>
<body>

    <div class="tv-header-display">
        <img id="appLogoDisplay" src="" alt="Logo">
        <h1 id="appTitleDisplay">...</h1>
    </div>

    <div class="control-bar">
        <div id="reloadBtn" class="btn-reload" tabindex="0">üîÑ T·∫£i l·∫°i trang</div>
    </div>

    <div class="grid-container" id="app"></div>


    <div class="spacer"></div>


    <div class="admin-section">
        <div class="admin-title">üõ†Ô∏è C·∫•u h√¨nh App</div>
        <div class="form-row">
            <input type="text" id="cfgTitle" placeholder="T√™n App (VD: K√™nh Gia ƒê√¨nh)">
            <input type="text" id="cfgLogo" placeholder="Link Logo (ƒê·ªÉ tr·ªëng n·∫øu ko c·∫ßn)">
            <button class="btn-action btn-save" onclick="saveConfig()">L∆ØU APP</button>
        </div>
    </div>


    <div class="admin-section">
        <div class="admin-title">üì∫ Qu·∫£n l√Ω M·ª•c (Phim / B√≥ng ƒê√°)</div>
        
        <div style="font-size: 0.9rem; color:#aaa; margin-bottom:5px;">Ch·ªçn nhanh Icon:</div>
        <div class="icon-suggestions">
            <div class="suggestion-chip" onclick="pickIcon('https://img.icons8.com/color/96/football2--v1.png')">‚öΩ B√≥ng ƒë√°</div>
            <div class="suggestion-chip" onclick="pickIcon('https://img.icons8.com/color/96/movie-projector.png')">üé¨ Phim</div>
            <div class="suggestion-chip" onclick="pickIcon('https://img.icons8.com/color/96/youtube-play.png')">üî¥ Youtube</div>
            <div class="suggestion-chip" onclick="pickIcon('https://img.icons8.com/color/96/retro-tv.png')">üì∫ TV</div>
            <div class="suggestion-chip" onclick="pickIcon('https://img.icons8.com/color/96/news.png')">üì∞ Tin t·ª©c</div>
            <div class="suggestion-chip" onclick="pickIcon('https://img.icons8.com/fluency/96/controller.png')">üéÆ Game</div>
        </div>

        <input type="hidden" id="editKey"> 
        <div class="form-row">
            <input type="text" id="newItemName" placeholder="T√™n m·ª•c (VD: Phim h√†nh ƒë·ªông)">
            <input type="text" id="newItemIcon" placeholder="Link Icon (ho·∫∑c Emoji)">
        </div>
        
        <div class="form-row">
            <input type="text" id="newItemUrl" placeholder="Link Web (https://...)" oninput="checkUrlLength(this)">
        </div>
        
        <div class="checkbox-container">
            <input type="checkbox" id="itemIgnore">
            <label for="itemIgnore" class="checkbox-label">
                <b>M·ªü b·∫±ng Tr√¨nh duy·ªát Web</b> (T√≠ch v√†o ƒë√¢y n·∫øu trang n√†y kh√¥ng xem ƒë∆∞·ª£c b·∫±ng Video Player ho·∫∑c mu·ªën ch·∫∑n b·∫Øt link .mp4/.m3u8)
            </label>
        </div>

        <div class="form-row">
            <button id="btnSaveItem" class="btn-action btn-add" onclick="handleSaveItem()">TH√äM M·ªöI</button>
            <button id="btnCancelEdit" class="btn-action btn-cancel" onclick="cancelEdit()">H·ª¶Y</button>
        </div>
        <div id="urlWarning" class="warning-text">‚ö†Ô∏è Link qu√° d√†i! C·∫©n th·∫≠n nh·∫≠p nh·∫ßm ho·∫∑c n√™n d√πng link r√∫t g·ªçn.</div>

        <div class="admin-item-list" id="adminList"></div>
    </div>


    <div class="admin-section block-section">
        <div class="admin-title block-title">üõ°Ô∏è Ch·∫∑n Qu·∫£ng C√°o (ƒê·ªìng b·ªô GitHub)</div>
        <div class="form-row">
            <input type="text" id="classInput" placeholder="Nh·∫≠p class/id (VD: .ads-box)">
            <button class="btn-action btn-save" style="background: #FF5722" onclick="addNewClass()">TH√äM BLOCK</button>
        </div>
        <div id="githubStatus" style="color: #888; font-style: italic; margin-top: 5px;">GitHub: S·∫µn s√†ng...</div>
        <div class="tag-container" id="tagList"></div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH ---
        const GITHUB_TOKEN = "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"; 
        const GITHUB_USER = "ThanhThankC";
        const GITHUB_REPO = "Haha";
        const GITHUB_FILE_PATH = "AppTV/classblock.txt";

        const firebaseConfig = {
            apiKey: "AIzaSyARyxrxmbNLaxSdDP14S5YQES5AJnLj-XU",
            authDomain: "mylife-ddd6a.firebaseapp.com",
            databaseURL: "https://mylife-ddd6a-default-rtdb.firebaseio.com",
            projectId: "mylife-ddd6a",
            storageBucket: "mylife-ddd6a.firebasestorage.app",
            messagingSenderId: "969759088030",
            appId: "1:969759088030:web:69155b992b0cea296e4a8f",
            measurementId: "G-V80ERR7KWQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const configRef = db.ref('app_config');
        const linksRef = db.ref('app_links');
        const blockedRef = db.ref('blocked_classes');

        // --- HELPER: Render Icon ---
        function renderIconHtml(iconVal, isSmall = false) {
            if (!iconVal) return `<span class="${isSmall?'':'card-icon-text'}">üì∫</span>`;
            if (iconVal.includes('http')) {
                return `<img src="${iconVal}" class="${isSmall?'':'card-icon-img'}" style="${isSmall?'width:24px;height:24px':''}">`;
            } else {
                return `<span class="${isSmall?'':'card-icon-text'}" style="${isSmall?'font-size:1.5rem':''}">${iconVal}</span>`;
            }
        }

        // --- LOGIC 1: APP CONFIG ---
        configRef.on('value', (snapshot) => {
            const data = snapshot.val() || { title: "K√äNH GIA ƒê√åNH", logo: "" };
            document.getElementById('appTitleDisplay').innerText = data.title;
            const logoDisplay = document.getElementById('appLogoDisplay');
            if (data.logo && data.logo.startsWith('http')) {
                logoDisplay.src = data.logo;
                logoDisplay.style.display = 'block';
            } else {
                logoDisplay.style.display = 'none';
            }
            document.getElementById('cfgTitle').value = data.title;
            document.getElementById('cfgLogo').value = data.logo;
        });

        window.saveConfig = function() {
            configRef.set({
                title: document.getElementById('cfgTitle').value.trim() || "K√äNH GIA ƒê√åNH",
                logo: document.getElementById('cfgLogo').value.trim()
            });
            alert("ƒê√£ l∆∞u c·∫•u h√¨nh App!");
        }

        // --- LOGIC 2: ITEM MANAGER (ADD / EDIT / DELETE) ---
        const appGrid = document.getElementById('app');
        const adminList = document.getElementById('adminList');
        
        // Inputs
        const nameInp = document.getElementById('newItemName');
        const urlInp = document.getElementById('newItemUrl');
        const iconInp = document.getElementById('newItemIcon');
        const ignoreCheck = document.getElementById('itemIgnore'); // Checkbox M·ªõi
        const editKeyInp = document.getElementById('editKey');
        const btnSave = document.getElementById('btnSaveItem');
        const btnCancel = document.getElementById('btnCancelEdit');
        const warnText = document.getElementById('urlWarning');

        // L·∫•y d·ªØ li·ªáu
        linksRef.on('value', (snapshot) => {
            appGrid.innerHTML = '';
            adminList.innerHTML = '';
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const key = child.key;
                    const item = child.val();

                    // 1. Grid TV
                    const card = document.createElement('a');
                    card.href = item.url;
                    card.className = 'card';
                    card.setAttribute('tabindex', '0');
                    card.innerHTML = `${renderIconHtml(item.icon)}<div class="card-title">${item.name}</div>`;
                    card.addEventListener('keydown', (e) => { if (e.key === 'Enter') window.location.href = item.url; });
                    appGrid.appendChild(card);

                    // 2. Admin List
                    const isIgnored = item.url.includes('#ignore');
                    const displayUrl = item.url.replace('#ignore', '');
                    const row = document.createElement('div');
                    row.className = 'admin-item-row';
                    row.innerHTML = `
                        <div class="item-preview">${renderIconHtml(item.icon, true)}</div>
                        <div class="item-info" onclick="startEdit('${key}', '${item.name}', '${item.url}', '${item.icon}')">
                            <b>${item.name}</b> ${isIgnored ? '<span style="color:orange; font-size:0.8rem; border:1px solid orange; padding:0 3px; border-radius:3px;">WEB ONLY</span>' : ''}<br>
                            <span style="color:#777; font-size:0.8rem">${displayUrl.substring(0,40)}...</span>
                        </div>
                        <button class="btn-action btn-edit" onclick="startEdit('${key}', '${item.name}', '${item.url}', '${item.icon}')">S·ª¨A</button>
                        <button class="btn-action btn-delete" onclick="deleteItem('${key}')">X√ìA</button>
                    `;
                    adminList.appendChild(row);
                });
            } else {
                adminList.innerHTML = '<div style="color:#666; font-style:italic">Ch∆∞a c√≥ k√™nh n√†o.</div>';
            }
        });

        // Ch·ªçn nhanh icon
        window.pickIcon = function(url) {
            iconInp.value = url;
        }

        // C·∫£nh b√°o link d√†i
        window.checkUrlLength = function(input) {
            if (input.value.length > 150) {
                warnText.style.display = 'block';
            } else {
                warnText.style.display = 'none';
            }
        }

        // B·∫Øt ƒë·∫ßu s·ª≠a
        window.startEdit = function(key, name, url, icon) {
            editKeyInp.value = key; // L∆∞u key v√†o hidden input
            nameInp.value = name;
            
            // X·ª≠ l√Ω logic Ignore khi s·ª≠a
            if (url.includes('#ignore')) {
                ignoreCheck.checked = true;
                urlInp.value = url.replace('#ignore', ''); // Hi·ªÉn th·ªã link s·∫°ch cho ng∆∞·ªùi d√πng s·ª≠a
            } else {
                ignoreCheck.checked = false;
                urlInp.value = url;
            }

            iconInp.value = icon;
            
            // ƒê·ªïi giao di·ªán n√∫t
            btnSave.innerText = "L∆ØU S·ª¨A";
            btnSave.style.backgroundColor = "#FF9800"; // M√†u cam
            btnCancel.style.display = "inline-block";
            
            // Scroll ƒë·∫øn form
            nameInp.focus();
        }

        // H·ªßy s·ª≠a
        window.cancelEdit = function() {
            editKeyInp.value = '';
            nameInp.value = '';
            urlInp.value = '';
            iconInp.value = '';
            ignoreCheck.checked = false; // Reset checkbox
            
            btnSave.innerText = "TH√äM M·ªöI";
            btnSave.style.backgroundColor = "#4CAF50"; // M√†u xanh
            btnCancel.style.display = "none";
            warnText.style.display = 'none';
        }

        // X·ª≠ l√Ω L∆∞u (Th√™m m·ªõi HO·∫∂C C·∫≠p nh·∫≠t)
        window.handleSaveItem = function() {
            const name = nameInp.value.trim();
            let url = urlInp.value.trim();
            const icon = iconInp.value.trim();
            const key = editKeyInp.value;

            if (!name || !url) {
                alert("Thi·∫øu T√™n ho·∫∑c Link!");
                return;
            }

            // LOGIC IGNORE: T·ª± ƒë·ªông th√™m ƒëu√¥i #ignore n·∫øu ƒë∆∞·ª£c t√≠ch
            // Tr∆∞·ªõc ti√™n x√≥a #ignore c≈© n·∫øu ng∆∞·ªùi d√πng l·ª° tay nh·∫≠p v√†o ƒë·ªÉ tr√°nh tr√πng l·∫∑p
            url = url.replace('#ignore', '');
            
            if (ignoreCheck.checked) {
                url = url + '#ignore';
            }

            if (key) {
                // ƒêang s·ª≠a -> Update
                linksRef.child(key).update({ name, url, icon });
            } else {
                // Kh√¥ng c√≥ key -> Th√™m m·ªõi
                linksRef.push({ name, url, icon });
            }
            cancelEdit(); // Reset form
        }

        window.deleteItem = function(key) {
            if (confirm("Ch·∫Øc ch·∫Øn x√≥a?")) {
                linksRef.child(key).remove();
                if (editKeyInp.value === key) cancelEdit(); // N·∫øu ƒëang s·ª≠a c√°i b·ªã x√≥a th√¨ h·ªßy lu√¥n
            }
        }


        // --- LOGIC 3: BLOCK LIST (Gi·ªØ nguy√™n) ---
        const classInput = document.getElementById('classInput');
        const tagList = document.getElementById('tagList');
        const statusText = document.getElementById('githubStatus');
        let currentClasses = [];

        window.addNewClass = function() {
            const val = classInput.value.trim();
            if (val) blockedRef.push(val).then(() => { classInput.value = ''; syncToGitHub(); });
        };
        window.deleteClass = function(key) {
            if(confirm("X√≥a ch·∫∑n class n√†y?")) blockedRef.child(key).remove().then(() => syncToGitHub());
        };
        blockedRef.on('value', (snapshot) => {
            tagList.innerHTML = ''; currentClasses = [];
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const val = child.val(); currentClasses.push(val);
                    const div = document.createElement('div'); div.className = 'tag-chip';
                    div.innerHTML = `<span>${val}</span><button class="tag-delete-btn" onclick="deleteClass('${child.key}')">√ó</button>`;
                    tagList.appendChild(div);
                });
            }
        });
        async function syncToGitHub() {
            statusText.innerText = "‚è≥ ƒêang ƒë·ªìng b·ªô GitHub..."; statusText.style.color = "orange";
            const contentString = currentClasses.join(", ");
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`;
            try {
                const getRes = await fetch(url, { headers: { "Authorization": `Bearer ${GITHUB_TOKEN}` } });
                let sha = null; if (getRes.ok) { const d = await getRes.json(); sha = d.sha; }
                const putRes = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `Bearer ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Upd", content: btoa(contentString), sha: sha })
                });
                if (putRes.ok) { statusText.innerText = "‚úÖ Xong!"; statusText.style.color = "#4CAF50"; }
                else { statusText.innerText = "‚ùå L·ªói GitHub"; statusText.style.color = "red"; }
            } catch (error) { console.error(error); }
        }


        // --- NAVIGATION ---
        function triggerReload() {
            if (window.AndroidApp && window.AndroidApp.reloadApp) {
                window.AndroidApp.reloadApp();
            } else {
                location.reload();
            }
        }

        const reloadBtn = document.getElementById('reloadBtn');
        reloadBtn.addEventListener('click', triggerReload);
        reloadBtn.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') triggerReload(); 
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const firstCard = document.querySelector('.card');
                if (firstCard) firstCard.focus();
            }
        });
        
        window.onload = function() {
            setTimeout(() => { const f = document.querySelector('.card'); if(f) f.focus(); }, 1500);
        };

        document.addEventListener('keydown', function(e) {
            if (document.activeElement.tagName === 'INPUT') return;
            const cards = Array.from(document.querySelectorAll('.card'));
            const current = document.activeElement;
            if (current === reloadBtn) return;
            
            const index = cards.indexOf(current);
            if (index === -1 && cards.length) { cards[0].focus(); return; }
            let next = index; const cols = 3;
            if (e.key === 'ArrowRight') next = index + 1;
            else if (e.key === 'ArrowLeft') next = index - 1;
            else if (e.key === 'ArrowDown') next = index + cols;
            else if (e.key === 'ArrowUp') {
                if (index < cols) { reloadBtn.focus(); e.preventDefault(); return; }
                next = index - cols;
            }
            if (next >= 0 && next < cards.length) { e.preventDefault(); cards[next].focus(); }
        });

    </script>
</body>
</html>
